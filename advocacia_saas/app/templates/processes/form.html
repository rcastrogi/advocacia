{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Início</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('processes.dashboard') }}">Processos</a></li>
            {% if is_edit %}
            <li class="breadcrumb-item"><a href="{{ url_for('processes.view', process_id=process.id) }}">{{ process.title[:30] }}...</a></li>
            <li class="breadcrumb-item active">Editar</li>
            {% else %}
            <li class="breadcrumb-item active">Novo Processo</li>
            {% endif %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-{{ 'edit' if is_edit else 'plus-circle' }} me-2 text-primary"></i>
            {{ 'Editar Processo' if is_edit else 'Novo Processo' }}
        </h1>
        <a href="{{ url_for('processes.list_processes') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <form method="POST" novalidate>
        {{ form.hidden_tag() }}
        
        <div class="row">
            <!-- Coluna Principal -->
            <div class="col-lg-8">
                <!-- Identificação -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            Identificação do Processo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-5 mb-3">
                                <label for="process_number" class="form-label">Número do Processo</label>
                                <div class="input-group">
                                    {{ form.process_number(class="form-control" + (" is-invalid" if form.process_number.errors else ""), id="process_number") }}
                                    <button type="button" class="btn btn-outline-primary" id="btnSearchDatajud" title="Buscar dados no DataJud">
                                        <i class="fas fa-search" id="iconSearch"></i>
                                        <span class="spinner-border spinner-border-sm d-none" id="spinnerSearch"></span>
                                    </button>
                                </div>
                                <small class="text-muted">Formato: 0000000-00.0000.0.00.0000</small>
                                {% for error in form.process_number.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                                <!-- Feedback DataJud -->
                                <div id="datajudFeedback" class="mt-2 d-none">
                                    <div class="alert alert-sm py-2 mb-0" id="datajudAlert">
                                        <small id="datajudMessage"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7 mb-3">
                                <label for="title" class="form-label">Título/Descrição <span class="text-danger">*</span></label>
                                {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                                {% for error in form.title.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="plaintiff" class="form-label">Autor/Requerente</label>
                                {{ form.plaintiff(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="defendant" class="form-label">Réu/Requerido</label>
                                {{ form.defendant(class="form-control") }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="client_id" class="form-label">Cliente Vinculado</label>
                            {{ form.client_id(class="form-select") }}
                            <small class="text-muted">Vincule este processo a um cliente cadastrado</small>
                        </div>
                    </div>
                </div>

                <!-- Informações do Tribunal -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-gavel me-2 text-primary"></i>
                            Informações do Tribunal
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="court" class="form-label">Justiça/Tribunal</label>
                                {{ form.court(class="form-select") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="court_instance" class="form-label">Instância</label>
                                {{ form.court_instance(class="form-select") }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="jurisdiction" class="form-label">Vara/Órgão Julgador</label>
                                {{ form.jurisdiction(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="district" class="form-label">Comarca/Foro</label>
                                {{ form.district(class="form-control") }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="judge" class="form-label">Juiz/Relator</label>
                            {{ form.judge(class="form-control") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna Lateral -->
            <div class="col-lg-4">
                <!-- Status e Prioridade -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-flag me-2 text-primary"></i>
                            Status e Prioridade
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                            {{ form.status(class="form-select") }}
                        </div>

                        <div class="mb-3">
                            <label for="priority" class="form-label">Prioridade <span class="text-danger">*</span></label>
                            {{ form.priority(class="form-select") }}
                        </div>

                        <div class="mb-3">
                            <label for="distribution_date" class="form-label">Data de Distribuição</label>
                            {{ form.distribution_date(class="form-control") }}
                        </div>
                    </div>
                </div>

                <!-- Controle de Prazos -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Controle de Prazos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="next_deadline" class="form-label">Próximo Prazo</label>
                            {{ form.next_deadline(class="form-control") }}
                        </div>

                        <div class="mb-3">
                            <label for="deadline_description" class="form-label">Descrição do Prazo</label>
                            {{ form.deadline_description(class="form-control") }}
                            <small class="text-muted">Ex: Prazo para contestação, Audiência de conciliação</small>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                {{ 'Salvar Alterações' if is_edit else 'Criar Processo' }}
                            </button>
                            
                            {% if is_edit %}
                            <a href="{{ url_for('processes.view', process_id=process.id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            {% else %}
                            <a href="{{ url_for('processes.list_processes') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;" id="toastContainer"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const processNumber = document.getElementById('process_number');
    const btnSearch = document.getElementById('btnSearchDatajud');
    const iconSearch = document.getElementById('iconSearch');
    const spinnerSearch = document.getElementById('spinnerSearch');
    const datajudFeedback = document.getElementById('datajudFeedback');
    const datajudAlert = document.getElementById('datajudAlert');
    const datajudMessage = document.getElementById('datajudMessage');
    
    // Função utilitária para escapar HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Função de Toast
    function showToast(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        
        const toastId = 'toast-' + Date.now();
        const icons = {
            success: 'fas fa-check-circle text-success',
            danger: 'fas fa-exclamation-circle text-danger',
            warning: 'fas fa-exclamation-triangle text-warning',
            info: 'fas fa-info-circle text-info'
        };
        const bgColors = {
            success: 'border-start border-success border-4',
            danger: 'border-start border-danger border-4',
            warning: 'border-start border-warning border-4',
            info: 'border-start border-info border-4'
        };
        
        const icon = icons[type] || icons.info;
        const bgColor = bgColors[type] || bgColors.info;
        
        const toastHtml = `
            <div id="${toastId}" class="toast ${bgColor}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="${duration}">
                <div class="toast-header">
                    <i class="${icon} me-2"></i>
                    <strong class="me-auto">${type === 'success' ? 'Sucesso' : type === 'danger' ? 'Erro' : type === 'warning' ? 'Aviso' : 'Informação'}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
                </div>
                <div class="toast-body">
                    ${escapeHtml(message)}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
        
        // Remove do DOM após fechar
        toastEl.addEventListener('hidden.bs.toast', () => {
            toastEl.remove();
        });
    }
    
    // Máscara para número do processo
    if (processNumber) {
        processNumber.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 20) {
                value = value.substring(0, 20);
            }
            
            // Formato: 0000000-00.0000.0.00.0000
            if (value.length > 0) {
                let formatted = value;
                if (value.length > 7) {
                    formatted = value.substring(0, 7) + '-' + value.substring(7);
                }
                if (value.length > 9) {
                    formatted = formatted.substring(0, 10) + '.' + value.substring(9);
                }
                if (value.length > 13) {
                    formatted = formatted.substring(0, 15) + '.' + value.substring(13);
                }
                if (value.length > 14) {
                    formatted = formatted.substring(0, 17) + '.' + value.substring(14);
                }
                if (value.length > 16) {
                    formatted = formatted.substring(0, 20) + '.' + value.substring(16);
                }
                e.target.value = formatted;
            }
        });
        
        // Busca automática quando terminar de digitar (20 dígitos)
        processNumber.addEventListener('input', function(e) {
            const digitsOnly = e.target.value.replace(/\D/g, '');
            if (digitsOnly.length === 20) {
                // Pequeno delay para não buscar enquanto digita
                clearTimeout(window.datajudTimeout);
                window.datajudTimeout = setTimeout(() => {
                    searchDatajud();
                }, 500);
            }
        });
    }
    
    // Botão de busca DataJud
    if (btnSearch) {
        btnSearch.addEventListener('click', searchDatajud);
    }
    
    function searchDatajud() {
        const numero = processNumber.value.trim();
        
        if (!numero || numero.replace(/\D/g, '').length < 15) {
            showFeedback('warning', 'Digite o número completo do processo (mínimo 15 dígitos).');
            return;
        }
        
        // Loading state
        setLoading(true);
        showFeedback('info', 'Consultando DataJud...');
        
        fetch('{{ url_for("processes.search_datajud") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                process_number: numero
            })
        })
        .then(response => {
            return response.json().then(data => {
                // Inclui o status na resposta para tratamento
                return { ok: response.ok, data: data };
            });
        })
        .then(result => {
            setLoading(false);
            
            if (result.ok && result.data.success) {
                showFeedback('success', 'Dados encontrados! Campos preenchidos automaticamente.');
                fillFormWithData(result.data.data);
                showProcessDetails(result.data.data);
            } else {
                showFeedback('warning', result.data.message || 'Processo não encontrado.');
            }
        })
        .catch(error => {
            setLoading(false);
            console.error('Erro ao consultar DataJud:', error);
            showFeedback('danger', 'Erro ao consultar DataJud. Tente novamente.');
        });
    }
    
    function setLoading(loading) {
        if (loading) {
            iconSearch.classList.add('d-none');
            spinnerSearch.classList.remove('d-none');
            btnSearch.disabled = true;
        } else {
            iconSearch.classList.remove('d-none');
            spinnerSearch.classList.add('d-none');
            btnSearch.disabled = false;
        }
    }
    
    function showFeedback(type, message) {
        const allowedTypes = ['success', 'danger', 'warning', 'info'];
        const safeType = allowedTypes.includes(type) ? type : 'info';
        
        // Mostra toast
        showToast(message, safeType);
        
        // Também mostra feedback inline (opcional)
        if (datajudFeedback && datajudAlert && datajudMessage) {
            datajudFeedback.classList.remove('d-none');
            datajudAlert.className = `alert alert-${safeType} py-2 mb-0`;
            datajudMessage.textContent = message;
            
            // Auto-hide após 10 segundos
            setTimeout(() => {
                datajudFeedback.classList.add('d-none');
            }, 10000);
        }
    }
    
    function fillFormWithData(data) {
        // Preenche campos do formulário com dados do DataJud
        const fieldMappings = {
            'title': data.title,
            'court': data.court,
            'court_instance': data.court_instance,
            'jurisdiction': data.jurisdiction,
            'distribution_date': data.distribution_date
        };
        
        for (const [fieldId, value] of Object.entries(fieldMappings)) {
            const field = document.getElementById(fieldId);
            if (field && value) {
                // Para selects, verificar se o valor existe nas opções
                if (field.tagName === 'SELECT') {
                    const option = Array.from(field.options).find(opt => opt.value === value);
                    if (option) {
                        field.value = value;
                    }
                } else {
                    // Só preenche se o campo estiver vazio
                    if (!field.value.trim()) {
                        field.value = value;
                    }
                }
                // Dispara evento change para triggers de validação
                field.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    }
    
    function showProcessDetails(data) {
        // Remove modal anterior se existir
        const existingModal = document.getElementById('datajudDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Cria modal com detalhes do processo
        const movimentosHtml = data.movimentos && data.movimentos.length > 0
            ? data.movimentos.map(m => 
                `<li class="list-group-item py-2">
                    <small class="text-muted">${m.data || 'Sem data'}</small><br>
                    <span>${escapeHtml(m.nome)}</span>
                </li>`
            ).join('')
            : '<li class="list-group-item">Nenhum movimento disponível</li>';
        
        const assuntosHtml = data.assuntos && data.assuntos.length > 0
            ? data.assuntos.map(a => `<span class="badge bg-secondary me-1">${escapeHtml(a)}</span>`).join('')
            : '<span class="text-muted">Não informado</span>';
        
        const modalHtml = `
            <div class="modal fade" id="datajudDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-gavel me-2"></i>
                                Dados do DataJud
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Tribunal:</strong> ${escapeHtml(data.tribunal || '-')}
                                </div>
                                <div class="col-md-6">
                                    <strong>Grau:</strong> ${escapeHtml(data.grau || '-')}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Classe:</strong> ${escapeHtml(data.classe || '-')}
                                </div>
                                <div class="col-md-6">
                                    <strong>Formato:</strong> ${escapeHtml(data.formato || '-')}
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>Órgão Julgador:</strong> ${escapeHtml(data.jurisdiction || '-')}
                            </div>
                            <div class="mb-3">
                                <strong>Assuntos:</strong><br>
                                ${assuntosHtml}
                            </div>
                            <div class="mb-3">
                                <strong>Última Atualização:</strong> ${data.ultima_atualizacao || '-'}
                            </div>
                            <hr>
                            <h6><i class="fas fa-history me-2"></i>Últimos Movimentos</h6>
                            <ul class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;">
                                ${movimentosHtml}
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        const modal = new bootstrap.Modal(document.getElementById('datajudDetailsModal'));
        modal.show();
    }
    
    function getCsrfToken() {
        // Tenta obter do meta tag
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta) return meta.getAttribute('content');
        
        // Tenta obter do input hidden
        const input = document.querySelector('input[name="csrf_token"]');
        if (input) return input.value;
        
        // Tenta função global se existir
        if (typeof window.getCsrfToken === 'function') {
            return window.getCsrfToken();
        }
        
        return '';
    }
});
</script>
{% endblock %}
