{% extends "base.html" %}

{% block styles %}
<style>
    .ql-container {
        border-radius: 0 0 4px 4px !important;
    }
    .ql-toolbar {
        border-radius: 4px 4px 0 0 !important;
    }
    
    /* Indicadores de validação em tempo real */
    .field-valid { border-color: #198754 !important; }
    .field-invalid { border-color: #dc3545 !important; }
    .field-warning { border-color: #ffc107 !important; }
    
    /* Status de salvamento automático */
    .auto-save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    .auto-save-indicator.saving { background: #ffc107; color: #000; }
    .auto-save-indicator.saved { background: #198754; color: #fff; }
    .auto-save-indicator.error { background: #dc3545; color: #fff; }
    
    /* Loading skeleton */
    .htmx-request .htmx-indicator { display: inline-block; }
    .htmx-indicator { display: none; }
    
    /* Transições suaves */
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* Card com efeito de hover */
    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .template-card { transition: all 0.2s ease; cursor: pointer; }
    
    /* Template selecionado - fundo claro com texto legível */
    .template-card.selected-template {
        background-color: #e8f4fc !important;
        border-color: var(--secondary-color, #c9a85c) !important;
        border-width: 2px !important;
    }
    .template-card.selected-template strong,
    .template-card.selected-template span {
        color: #1a1a1a !important;
    }
    
    /* Seções colapsáveis */
    .collapsible-section .section-header {
        cursor: pointer;
        user-select: none;
    }
    .collapsible-section .section-header:hover {
        background-color: rgba(0,0,0,0.02);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" 
     x-data="familyPetitionForm()" 
     x-init="init()"
     @keydown.ctrl.s.prevent="saveAsDraft()">
    
    <!-- Auto-save indicator -->
    <div class="auto-save-indicator" 
         x-show="autoSaveStatus !== 'idle'"
         x-transition
         :class="{
             'saving': autoSaveStatus === 'saving',
             'saved': autoSaveStatus === 'saved',
             'error': autoSaveStatus === 'error'
         }">
        <span x-show="autoSaveStatus === 'saving'">
            <i class="fas fa-circle-notch fa-spin me-1"></i> Salvando...
        </span>
        <span x-show="autoSaveStatus === 'saved'">
            <i class="fas fa-check me-1"></i> Salvo automaticamente
        </span>
        <span x-show="autoSaveStatus === 'error'">
            <i class="fas fa-exclamation-triangle me-1"></i> Erro ao salvar
        </span>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="fas fa-people-roof"></i> Petições de Família</h1>
            <p class="text-muted mb-0">Preencha os dados da família e anexe documentos para gerar o PDF ou um pacote completo.</p>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <a href="{{ url_for('main.peticionador') }}" class="btn btn-sm btn-outline-secondary d-flex align-items-center">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
            <a href="{{ url_for('petitions.personal_templates') }}" class="btn btn-sm btn-outline-primary d-flex align-items-center">
                <i class="fas fa-user-pen me-1"></i> Novo modelo
            </a>
            {% if current_user.user_type == 'master' %}
            <a href="{{ url_for('petitions.manage_global_templates') }}" class="btn btn-sm btn-primary d-flex align-items-center">
                <i class="fas fa-layer-group me-1"></i> Modelos padrão
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <strong>Dados da Petição de Família</strong>
                    <div class="d-flex gap-2">
                        <button type="button" 
                                class="btn btn-sm btn-outline-light" 
                                @click="loadTemplate()"
                                :disabled="loading || !selectedTemplate"
                                title="Carregar textos padrão do modelo selecionado">
                            <span x-show="!loading">
                                <i class="fas fa-magic me-1"></i> Carregar Modelo
                            </span>
                            <span x-show="loading">
                                <i class="fas fa-spinner fa-spin me-1"></i> Carregando...
                            </span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="familyPetitionForm" @submit.prevent="submitForm($event)">
                        {{ form.hidden_tag() }}

                        <!-- Seção 1: Dados Básicos -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.basic = !sections.basic">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.basic }"></i>
                                    Dados Básicos da Ação
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.basic ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.basic" x-transition class="pt-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.template_id.label }}</label>
                                        {{ form.template_id(class_='form-select', id='template_id', **{'x-model': 'selectedTemplate', '@change': 'onTemplateChange()'}) }}
                                        <small class="text-muted">Selecione e clique em "Carregar Modelo".</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.action_type.label }} <span class="text-danger">*</span></label>
                                        {{ form.action_type(class_='form-control', **{'x-model': 'formData.action_type', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.process_number.label }}</label>
                                        {{ form.process_number(class_='form-control', **{'x-model': 'formData.process_number', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.forum.label }}</label>
                                        {{ form.forum(class_='form-control', **{'x-model': 'formData.forum', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.vara.label }}</label>
                                        {{ form.vara(class_='form-control', **{'x-model': 'formData.vara', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 2: Dados do Casamento -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.marriage = !sections.marriage">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.marriage }"></i>
                                    Dados do Casamento
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.marriage ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.marriage" x-transition class="pt-3">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">{{ form.marriage_date.label }}</label>
                                        {{ form.marriage_date(class_='form-control', **{'x-model': 'formData.marriage_date', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">{{ form.marriage_city.label }}</label>
                                        {{ form.marriage_city(class_='form-control', **{'x-model': 'formData.marriage_city', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">{{ form.marriage_regime.label }}</label>
                                        {{ form.marriage_regime(class_='form-select', **{'x-model': 'formData.marriage_regime', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>

                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label">{{ form.separation_date.label }}</label>
                                        {{ form.separation_date(class_='form-control', **{'x-model': 'formData.separation_date', '@input.debounce.500ms': 'markDirty()'}) }}
                                        <small class="text-muted">Para divórcio litigioso</small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mt-4">
                                            {{ form.has_prenup(class_='form-check-input', **{'x-model': 'formData.has_prenup'}) }}
                                            {{ form.has_prenup.label(class_='form-check-label') }}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">{{ form.prenup_details.label }}</label>
                                        {{ form.prenup_details(class_='form-control', placeholder='Resumo do pacto, se existir', **{'x-model': 'formData.prenup_details', '@input.debounce.500ms': 'markDirty()', ':disabled': '!formData.has_prenup'}) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 3: Cônjuges -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.spouses = !sections.spouses">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.spouses }"></i>
                                    Partes (Cônjuges)
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.spouses ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.spouses" x-transition class="pt-3">
                                <!-- Autora/Autor -->
                                <div class="border rounded p-3 mb-3 bg-light">
                                    <h6 class="text-muted mb-3"><i class="fas fa-user me-2"></i>Autora/Autor</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">{{ form.spouse_one_name.label }} <span class="text-danger">*</span></label>
                                            {{ form.spouse_one_name(class_='form-control', **{'x-model': 'formData.spouse_one_name', '@input.debounce.500ms': 'validateField(\"spouse_one_name\")', ':class': 'getFieldClass(\"spouse_one_name\")', 'required': 'required'}) }}
                                            <small class="text-danger" x-show="errors.spouse_one_name" x-text="errors.spouse_one_name"></small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">{{ form.author_cpf.label }}</label>
                                            {{ form.author_cpf(class_='form-control', **{'x-model': 'formData.author_cpf', '@input.debounce.500ms': 'markDirty()'}) }}
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">{{ form.spouse_one_qualification.label }}</label>
                                            {{ form.spouse_one_qualification(class_='form-control', placeholder='Nacionalidade, profissão, estado civil, RG, CPF, etc.', **{'x-model': 'formData.spouse_one_qualification', '@input.debounce.500ms': 'markDirty()'}) }}
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">{{ form.author_address.label }}</label>
                                            {{ form.author_address(class_='form-control', **{'x-model': 'formData.author_address', '@input.debounce.500ms': 'markDirty()'}) }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Réu/Ré -->
                                <div class="border rounded p-3 bg-light">
                                    <h6 class="text-muted mb-3"><i class="fas fa-user-slash me-2"></i>Réu/Ré</h6>
                                    <div class="row g-3">
                                        <div class="col-md-12">
                                            <label class="form-label">{{ form.spouse_two_name.label }} <span class="text-danger">*</span></label>
                                            {{ form.spouse_two_name(class_='form-control', **{'x-model': 'formData.spouse_two_name', '@input.debounce.500ms': 'validateField(\"spouse_two_name\")', ':class': 'getFieldClass(\"spouse_two_name\")', 'required': 'required'}) }}
                                            <small class="text-danger" x-show="errors.spouse_two_name" x-text="errors.spouse_two_name"></small>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">{{ form.spouse_two_qualification.label }}</label>
                                            {{ form.spouse_two_qualification(class_='form-control', placeholder='Nacionalidade, profissão, estado civil, RG, CPF, etc.', **{'x-model': 'formData.spouse_two_qualification', '@input.debounce.500ms': 'markDirty()'}) }}
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">{{ form.defendant_address.label }}</label>
                                            {{ form.defendant_address(class_='form-control', **{'x-model': 'formData.defendant_address', '@input.debounce.500ms': 'markDirty()'}) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 4: Filhos e Guarda -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.children = !sections.children">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.children }"></i>
                                    Filhos, Guarda e Pensão
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.children ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.children" x-transition class="pt-3">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.children_info.label }}</label>
                                        {{ form.children_info(class_='form-control', **{'x-model': 'formData.children_info', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.children_names.label }}</label>
                                        {{ form.children_names(class_='form-control', **{'x-model': 'formData.children_names', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.custody_plan.label }}</label>
                                        {{ form.custody_plan(class_='form-control', **{'x-model': 'formData.custody_plan', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                                
                                <hr class="my-3">
                                <h6 class="text-muted mb-3"><i class="fas fa-money-bill-wave me-2"></i>Pensão Alimentícia</h6>
                                
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.alimony_plan.label }}</label>
                                        {{ form.alimony_plan(class_='form-control', **{'x-model': 'formData.alimony_plan', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.defendant_income.label }}</label>
                                        {{ form.defendant_income(class_='form-control', **{'x-model': 'formData.defendant_income', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.alimony_amount.label }}</label>
                                        {{ form.alimony_amount(class_='form-control', **{'x-model': 'formData.alimony_amount', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.health_plan_details.label }}</label>
                                        {{ form.health_plan_details(class_='form-control', **{'x-model': 'formData.health_plan_details', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 5: Patrimônio e Dívidas -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.property = !sections.property">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.property }"></i>
                                    Patrimônio e Dívidas
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.property ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.property" x-transition class="pt-3">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.property_description.label }}</label>
                                        {{ form.property_description(class_='form-control', placeholder='Imóveis, veículos, quotas, aplicações...', **{'x-model': 'formData.property_description', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.debts_description.label }}</label>
                                        {{ form.debts_description(class_='form-control', **{'x-model': 'formData.debts_description', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 6: Violência Doméstica / Medida Protetiva -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.violence = !sections.violence">
                                <h6 class="mb-0 text-danger">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.violence }"></i>
                                    Violência Doméstica / Medida Protetiva
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.violence ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.violence" x-transition class="pt-3">
                                <div class="alert alert-warning small mb-3">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Preencha esta seção apenas se houver situação de violência doméstica. Estas informações serão incluídas na petição com base na Lei Maria da Penha (Lei 11.340/06).
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            {{ form.has_domestic_violence(class_='form-check-input', **{'x-model': 'formData.has_domestic_violence'}) }}
                                            {{ form.has_domestic_violence.label(class_='form-check-label') }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            {{ form.has_protective_order(class_='form-check-input', **{'x-model': 'formData.has_protective_order', ':disabled': '!formData.has_domestic_violence'}) }}
                                            {{ form.has_protective_order.label(class_='form-check-label') }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3 mt-2" x-show="formData.has_domestic_violence" x-transition>
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.domestic_violence_facts.label }}</label>
                                        {{ form.domestic_violence_facts(class_='form-control', **{'x-model': 'formData.domestic_violence_facts', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-12" x-show="formData.has_protective_order">
                                        <label class="form-label">{{ form.protective_order_details.label }}</label>
                                        {{ form.protective_order_details(class_='form-control', **{'x-model': 'formData.protective_order_details', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.moral_damages_amount.label }}</label>
                                        {{ form.moral_damages_amount(class_='form-control', **{'x-model': 'formData.moral_damages_amount', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 7: Conteúdo da Petição -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.content = !sections.content">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.content }"></i>
                                    Conteúdo da Petição
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.content ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.content" x-transition class="pt-3">
                                <div class="mb-3">
                                    <label class="form-label">{{ form.divorce_facts.label }}</label>
                                    {{ form.divorce_facts(class_='form-control petition-editor', id='divorce_facts') }}
                                    <small class="text-muted">Fatos específicos do divórcio (será usado na seção 1.1 do documento)</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ form.facts.label }} <span class="text-danger">*</span></label>
                                    {{ form.facts(class_='form-control petition-editor', id='facts') }}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ form.fundamentos.label }} <span class="text-danger">*</span></label>
                                    {{ form.fundamentos(class_='form-control petition-editor', id='fundamentos') }}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ form.pedidos.label }} <span class="text-danger">*</span></label>
                                    {{ form.pedidos(class_='form-control petition-editor', id='pedidos') }}
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.valor_causa.label }}</label>
                                        {{ form.valor_causa(class_='form-control', **{'x-model': 'formData.valor_causa', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 8: Assinatura e Anexos -->
                        <div class="collapsible-section mb-4">
                            <div class="section-header d-flex justify-content-between align-items-center pb-2 border-bottom" @click="sections.signature = !sections.signature">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-caret-down me-2" :class="{ 'fa-rotate-270': !sections.signature }"></i>
                                    Assinatura e Anexos
                                </h6>
                                <span class="badge bg-secondary" x-text="sections.signature ? 'Expandido' : 'Recolhido'"></span>
                            </div>
                            <div x-show="sections.signature" x-transition class="pt-3">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">{{ form.cidade.label }}</label>
                                        {{ form.cidade(class_='form-control', **{'x-model': 'formData.cidade', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">{{ form.data_assinatura.label }}</label>
                                        {{ form.data_assinatura(class_='form-control', **{'x-model': 'formData.data_assinatura', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                                
                                <div class="row g-3 mt-3">
                                    <div class="col-12">
                                        <div class="alert alert-info mb-0 py-2">
                                            <i class="fas fa-user-tie me-2"></i>
                                            <strong>Advogado:</strong> {{ form.advogado_nome.data }} - <strong>OAB:</strong> {{ form.advogado_oab.data }}
                                            <small class="text-muted ms-2">(dados do perfil)</small>
                                        </div>
                                        {{ form.advogado_nome(type='hidden') }}
                                        {{ form.advogado_oab(type='hidden') }}
                                    </div>
                                </div>

                                <div class="row g-3 mt-3">
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.lawyer_address.label }}</label>
                                        {{ form.lawyer_address(class_='form-control', **{'x-model': 'formData.lawyer_address', '@input.debounce.500ms': 'markDirty()'}) }}
                                    </div>
                                </div>
                                
                                <hr class="my-3">
                                <h6 class="text-muted mb-3"><i class="fas fa-file-signature me-2"></i>Opções Adicionais</h6>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">{{ form.name_change.label }}</label>
                                        {{ form.name_change(class_='form-control', **{'x-model': 'formData.name_change', '@input.debounce.500ms': 'markDirty()'}) }}
                                        <small class="text-muted">Preencha se desejar retornar ao nome de solteira</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch mt-4">
                                            {{ form.request_free_justice(class_='form-check-input', **{'x-model': 'formData.request_free_justice'}) }}
                                            {{ form.request_free_justice.label(class_='form-check-label') }}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch mt-4">
                                            {{ form.signature_author(class_='form-check-input', **{'x-model': 'formData.signature_author'}) }}
                                            {{ form.signature_author.label(class_='form-check-label') }}
                                        </div>
                                    </div>
                                </div>
                                
                                <hr class="my-3">
                                <h6 class="text-muted mb-3"><i class="fas fa-paperclip me-2"></i>Documentos Anexos</h6>
                                
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">{{ form.documents.label }}</label>
                                        {{ form.documents(class_='form-control', **{'@change': 'handleFiles($event)'}) }}
                                        <small class="text-muted">Até 5 arquivos (pdf, doc, docx, png, jpg) com 5 MB cada.</small>
                                    </div>
                                </div>

                                <!-- Lista de arquivos selecionados -->
                                <div class="mt-3" x-show="selectedFiles.length > 0">
                                    <label class="form-label small text-muted">Arquivos selecionados:</label>
                                    <ul class="list-group list-group-flush small">
                                        <template x-for="(file, index) in selectedFiles" :key="index">
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                                                <span><i class="fas fa-file me-2"></i><span x-text="file.name"></span></span>
                                                <span class="badge bg-secondary" x-text="formatFileSize(file.size)"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <!-- Validação visual dos campos obrigatórios -->
                            <div class="alert alert-light border mb-3" x-show="!isFormValid()" x-transition>
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-exclamation-circle text-warning me-1"></i>
                                    Preencha os campos obrigatórios para gerar o PDF:
                                </h6>
                                <ul class="mb-0 small">
                                    <li :class="formData.spouse_one_name ? 'text-success' : 'text-danger'">
                                        <i :class="formData.spouse_one_name ? 'fas fa-check' : 'fas fa-times'"></i>
                                        Nome da Autora/Autor
                                    </li>
                                    <li :class="formData.spouse_two_name ? 'text-success' : 'text-danger'">
                                        <i :class="formData.spouse_two_name ? 'fas fa-check' : 'fas fa-times'"></i>
                                        Nome do Réu/Ré
                                    </li>
                                    <li :class="hasEditorContent('facts') ? 'text-success' : 'text-danger'">
                                        <i :class="hasEditorContent('facts') ? 'fas fa-check' : 'fas fa-times'"></i>
                                        Fatos
                                    </li>
                                    <li :class="hasEditorContent('fundamentos') ? 'text-success' : 'text-danger'">
                                        <i :class="hasEditorContent('fundamentos') ? 'fas fa-check' : 'fas fa-times'"></i>
                                        Fundamentação Jurídica
                                    </li>
                                    <li :class="hasEditorContent('pedidos') ? 'text-success' : 'text-danger'">
                                        <i :class="hasEditorContent('pedidos') ? 'fas fa-check' : 'fas fa-times'"></i>
                                        Pedidos
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-muted small" x-show="isDirty">
                                        <i class="fas fa-circle text-warning me-1" style="font-size: 8px;"></i>
                                        Alterações não salvas
                                    </span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" 
                                            class="btn btn-outline-secondary"
                                            @click="saveAsDraft()"
                                            :disabled="submitting">
                                        <i class="fas fa-save me-1"></i> Salvar Rascunho
                                    </button>
                                    <div class="position-relative" 
                                         x-data="{ showTooltip: false }"
                                         @mouseenter="showTooltip = !isFormValid()"
                                         @mouseleave="showTooltip = false">
                                        <button type="submit" 
                                                class="btn btn-lg btn-primary"
                                                :disabled="submitting || !isFormValid()"
                                                :class="{ 'opacity-50': !isFormValid() }">
                                            <span x-show="!submitting">
                                                <i class="fas fa-file-pdf me-1"></i> {{ form.submit.label.text }}
                                            </span>
                                            <span x-show="submitting">
                                                <i class="fas fa-spinner fa-spin me-1"></i> Gerando...
                                            </span>
                                        </button>
                                        <!-- Tooltip explicativo -->
                                        <div x-show="showTooltip" 
                                             x-transition
                                             class="position-absolute bottom-100 end-0 mb-2 p-2 bg-dark text-white rounded shadow-sm small"
                                             style="min-width: 250px; z-index: 1000;">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Preencha todos os campos obrigatórios acima para habilitar este botão.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Templates disponíveis com seleção rápida -->
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Modelos disponíveis</strong>
                    <button class="btn btn-sm btn-link p-0" 
                            hx-get="{{ url_for('petitions.family_templates_partial') }}"
                            hx-target="#family-templates-list"
                            hx-swap="innerHTML"
                            hx-indicator="#family-templates-loading">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body" id="family-templates-list">
                    <div id="family-templates-loading" class="htmx-indicator text-center py-3">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-uppercase text-muted small mb-1">
                            <i class="fas fa-building-columns me-1"></i> Padrão da plataforma
                        </h6>
                        <small class="text-muted d-block mb-2">Modelos prontos disponibilizados pelo sistema</small>
                    </div>
                    <ul class="list-unstyled mb-4">
                        {% for tpl in templates if tpl.is_global %}
                            <li class="mb-2 template-card p-2 rounded border bg-light"
                                @click="selectTemplate('{{ tpl.id }}')"
                                :class="selectedTemplate == '{{ tpl.id }}' ? 'border-primary selected-template' : ''">
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-primary me-2" style="font-size: 0.65rem;">PADRÃO</span>
                                    <div>
                                        <strong>{{ tpl.name }}</strong>
                                        {% if tpl.petition_type %}
                                        <span class="text-muted small d-block">{{ tpl.petition_type.name }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li class="text-muted small fst-italic">Nenhum modelo padrão disponível.</li>
                        {% endfor %}
                    </ul>

                    <div class="mb-3">
                        <h6 class="text-uppercase text-muted small mb-1">
                            <i class="fas fa-user-pen me-1"></i> Modelos do meu escritório
                        </h6>
                        <small class="text-muted d-block mb-2">Seus modelos personalizados</small>
                    </div>
                    <ul class="list-unstyled mb-0">
                        {% for tpl in templates if not tpl.is_global %}
                            <li class="mb-2 template-card p-2 rounded border"
                                @click="selectTemplate('{{ tpl.id }}')"
                                :class="selectedTemplate == '{{ tpl.id }}' ? 'border-primary selected-template' : ''">
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-success me-2" style="font-size: 0.65rem;">MEU</span>
                                    <div>
                                        <strong>{{ tpl.name }}</strong>
                                        {% if tpl.petition_type %}
                                        <span class="text-muted small d-block">{{ tpl.petition_type.name }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li class="text-muted small fst-italic py-2">
                                <i class="fas fa-info-circle me-1"></i> Você ainda não criou modelos próprios.
                                <a href="{{ url_for('petitions.create_personal_template') }}" class="d-block mt-1">
                                    <i class="fas fa-plus me-1"></i> Criar meu primeiro modelo
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Progress indicator -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <strong><i class="fas fa-tasks text-primary me-1"></i> Progresso</strong>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-primary" 
                             role="progressbar" 
                             :style="{ width: progressPercentage + '%' }"
                             :aria-valuenow="progressPercentage" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted" x-text="progressPercentage + '% preenchido'"></small>
                    
                    <ul class="list-unstyled mt-3 small">
                        <li :class="formData.spouse_one_name ? 'text-success' : 'text-muted'">
                            <i :class="formData.spouse_one_name ? 'fas fa-check-circle' : 'far fa-circle'"></i> Cônjuge 1
                        </li>
                        <li :class="formData.spouse_two_name ? 'text-success' : 'text-muted'">
                            <i :class="formData.spouse_two_name ? 'fas fa-check-circle' : 'far fa-circle'"></i> Cônjuge 2
                        </li>
                        <li :class="hasEditorContent('facts') ? 'text-success' : 'text-muted'">
                            <i :class="hasEditorContent('facts') ? 'fas fa-check-circle' : 'far fa-circle'"></i> Fatos
                        </li>
                        <li :class="hasEditorContent('fundamentos') ? 'text-success' : 'text-muted'">
                            <i :class="hasEditorContent('fundamentos') ? 'fas fa-check-circle' : 'far fa-circle'"></i> Fundamentação
                        </li>
                        <li :class="hasEditorContent('pedidos') ? 'text-success' : 'text-muted'">
                            <i :class="hasEditorContent('pedidos') ? 'fas fa-check-circle' : 'far fa-circle'"></i> Pedidos
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Dicas -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <strong><i class="fas fa-lightbulb text-warning me-1"></i> Dicas Rápidas</strong>
                </div>
                <div class="card-body">
                    <ul class="small text-muted mb-3">
                        <li class="mb-2"><strong>Seções:</strong> Clique nos cabeçalhos para expandir/recolher.</li>
                        <li class="mb-2"><strong>Auto-save:</strong> Salvo automaticamente a cada 30s.</li>
                        <li class="mb-2"><strong>Atalho:</strong> <kbd>Ctrl</kbd>+<kbd>S</kbd> para rascunho.</li>
                        <li>Os anexos são agrupados com o PDF em um .zip.</li>
                    </ul>
                    
                    <div class="alert alert-info small mb-0 py-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Campos com <span class="text-danger">*</span> são obrigatórios.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Alpine.js component para o formulário de petição de família
function familyPetitionForm() {
    return {
        // Estado do formulário
        selectedTemplate: '{{ form.template_id.data or "" }}',
        loading: false,
        submitting: false,
        isDirty: false,
        autoSaveStatus: 'idle',
        selectedFiles: [],
        
        // Seções colapsáveis
        sections: {
            basic: true,
            marriage: true,
            spouses: true,
            children: true,
            property: true,
            violence: false,
            content: true,
            signature: true
        },
        
        // Dados do formulário
        formData: {
            action_type: '{{ form.action_type.data or "" }}',
            process_number: '{{ form.process_number.data or "" }}',
            forum: '{{ form.forum.data or "" }}',
            vara: '{{ form.vara.data or "" }}',
            // Casamento
            marriage_date: '{{ form.marriage_date.data or "" }}',
            marriage_city: '{{ form.marriage_city.data or "" }}',
            marriage_regime: '{{ form.marriage_regime.data or "" }}',
            separation_date: '{{ form.separation_date.data or "" }}',
            has_prenup: {{ 'true' if form.has_prenup.data else 'false' }},
            prenup_details: '{{ form.prenup_details.data or "" }}',
            // Partes
            spouse_one_name: '{{ form.spouse_one_name.data or "" }}',
            spouse_one_qualification: '{{ form.spouse_one_qualification.data or "" }}',
            author_address: '{{ form.author_address.data or "" }}',
            author_cpf: '{{ form.author_cpf.data or "" }}',
            spouse_two_name: '{{ form.spouse_two_name.data or "" }}',
            spouse_two_qualification: '{{ form.spouse_two_qualification.data or "" }}',
            defendant_address: '{{ form.defendant_address.data or "" }}',
            // Filhos e pensão
            children_info: '{{ form.children_info.data or "" }}',
            children_names: '{{ form.children_names.data or "" }}',
            custody_plan: '{{ form.custody_plan.data or "" }}',
            alimony_plan: '{{ form.alimony_plan.data or "" }}',
            defendant_income: '{{ form.defendant_income.data or "" }}',
            alimony_amount: '{{ form.alimony_amount.data or "" }}',
            health_plan_details: '{{ form.health_plan_details.data or "" }}',
            // Patrimônio e dívidas
            property_description: '{{ form.property_description.data or "" }}',
            debts_description: '{{ form.debts_description.data or "" }}',
            // Violência doméstica
            has_domestic_violence: {{ 'true' if form.has_domestic_violence.data else 'false' }},
            domestic_violence_facts: '{{ form.domestic_violence_facts.data or "" }}',
            has_protective_order: {{ 'true' if form.has_protective_order.data else 'false' }},
            protective_order_details: '{{ form.protective_order_details.data or "" }}',
            moral_damages_amount: '{{ form.moral_damages_amount.data or "" }}',
            // Conteúdo dos editores (para validação reativa)
            facts_content: '',
            fundamentos_content: '',
            pedidos_content: '',
            // Valor
            valor_causa: '{{ form.valor_causa.data or "" }}',
            // Assinatura
            cidade: '{{ form.cidade.data or "" }}',
            data_assinatura: '{{ form.data_assinatura.data or "" }}',
            advogado_nome: '{{ form.advogado_nome.data or "" }}',
            advogado_oab: '{{ form.advogado_oab.data or "" }}',
            lawyer_address: '{{ form.lawyer_address.data or "" }}',
            name_change: '{{ form.name_change.data or "" }}',
            request_free_justice: {{ 'true' if form.request_free_justice.data else 'true' }},
            signature_author: {{ 'true' if form.signature_author.data else 'false' }}
        },
        
        // Erros de validação
        errors: {},
        touched: {},
        
        // Computed: progresso
        get progressPercentage() {
            let filled = 0;
            let total = 5;
            
            if (this.formData.spouse_one_name) filled++;
            if (this.formData.spouse_two_name) filled++;
            if (this.hasEditorContent('facts')) filled++;
            if (this.hasEditorContent('fundamentos')) filled++;
            if (this.hasEditorContent('pedidos')) filled++;
            
            return Math.round((filled / total) * 100);
        },
        
        // Inicialização
        init() {
            this.initEditors();
            this.setupAutoSave();
            
            window.addEventListener('beforeunload', (e) => {
                if (this.isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        },
        
        // Inicializa editores Quill
        initEditors() {
            const self = this;
            
            // Inicializa Quill para cada textarea .petition-editor
            document.querySelectorAll('.petition-editor').forEach(textarea => {
                if (textarea._quillInitialized) return;
                
                // Cria container para o Quill
                const container = document.createElement('div');
                container.className = 'quill-editor-container';
                container.style.minHeight = '250px';
                
                textarea.parentNode.insertBefore(container, textarea);
                textarea.style.display = 'none';
                textarea._quillInitialized = true;
                
                const quill = new Quill(container, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            ['clean']
                        ]
                    },
                    placeholder: 'Digite aqui...'
                });
                
                // Carrega conteúdo inicial
                if (textarea.value) {
                    quill.root.innerHTML = textarea.value;
                    // Sincroniza com formData
                    const text = quill.getText().trim();
                    if (textarea.id === 'facts') {
                        self.formData.facts_content = text;
                    } else if (textarea.id === 'fundamentos') {
                        self.formData.fundamentos_content = text;
                    } else if (textarea.id === 'pedidos') {
                        self.formData.pedidos_content = text;
                    }
                }
                
                // Sincroniza mudanças
                quill.on('text-change', function() {
                    textarea.value = quill.root.innerHTML;
                    self.markDirty();
                    // Atualiza o formData para validação reativa
                    const text = quill.getText().trim();
                    if (textarea.id === 'facts') {
                        self.formData.facts_content = text;
                    } else if (textarea.id === 'fundamentos') {
                        self.formData.fundamentos_content = text;
                    } else if (textarea.id === 'pedidos') {
                        self.formData.pedidos_content = text;
                    }
                });
                
                // Guarda referência
                textarea._quill = quill;
            });
        },
        
        // Auto-save
        setupAutoSave() {
            setInterval(() => {
                if (this.isDirty) {
                    this.autoSave();
                }
            }, 30000);
        },
        
        markDirty() {
            this.isDirty = true;
        },
        
        selectTemplate(templateId) {
            this.selectedTemplate = templateId;
            document.getElementById('template_id').value = templateId;
        },
        
        onTemplateChange() {},
        
        async loadTemplate() {
            if (!this.selectedTemplate) {
                window.showToast('Selecione um modelo primeiro.', 'warning');
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch(`/petitions/api/template/${this.selectedTemplate}/defaults`);
                if (!response.ok) throw new Error('Erro ao carregar modelo');
                
                const data = await response.json();
                const defaults = data.defaults || {};
                
                if (Object.keys(defaults).length === 0) {
                    window.showToast('Este modelo não possui textos padrão configurados.', 'info');
                    return;
                }
                
                const factsTextarea = document.getElementById('facts');
                const fundamentosTextarea = document.getElementById('fundamentos');
                const pedidosTextarea = document.getElementById('pedidos');
                
                let hasContent = (factsTextarea._quill && factsTextarea._quill.getText().trim()) || 
                                 (fundamentosTextarea._quill && fundamentosTextarea._quill.getText().trim()) || 
                                 (pedidosTextarea._quill && pedidosTextarea._quill.getText().trim());
                
                if (hasContent) {
                    if (!confirm('Os campos já possuem conteúdo. Deseja substituir pelo texto do modelo?')) {
                        return;
                    }
                }
                
                if (defaults.facts && factsTextarea._quill) {
                    factsTextarea._quill.root.innerHTML = defaults.facts;
                    factsTextarea.value = defaults.facts;
                    this.formData.facts_content = factsTextarea._quill.getText().trim();
                }
                if (defaults.fundamentos && fundamentosTextarea._quill) {
                    fundamentosTextarea._quill.root.innerHTML = defaults.fundamentos;
                    fundamentosTextarea.value = defaults.fundamentos;
                    this.formData.fundamentos_content = fundamentosTextarea._quill.getText().trim();
                }
                if (defaults.pedidos && pedidosTextarea._quill) {
                    pedidosTextarea._quill.root.innerHTML = defaults.pedidos;
                    pedidosTextarea.value = defaults.pedidos;
                    this.formData.pedidos_content = pedidosTextarea._quill.getText().trim();
                }
                
                this.isDirty = true;
                window.showToast('Modelo carregado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                window.showToast('Erro ao carregar o modelo.', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        validateField(fieldName) {
            this.touched[fieldName] = true;
            this.markDirty();
            
            const value = this.formData[fieldName];
            
            switch(fieldName) {
                case 'spouse_one_name':
                case 'spouse_two_name':
                    if (!value || value.trim().length < 3) {
                        this.errors[fieldName] = 'Nome deve ter pelo menos 3 caracteres';
                    } else {
                        delete this.errors[fieldName];
                    }
                    break;
            }
        },
        
        getFieldClass(fieldName) {
            if (!this.touched[fieldName]) return 'form-control';
            if (this.errors[fieldName]) return 'form-control field-invalid';
            if (this.formData[fieldName]) return 'form-control field-valid';
            return 'form-control';
        },
        
        hasEditorContent(editorId) {
            // Usa os campos reativos do formData
            if (editorId === 'facts') {
                return this.formData.facts_content && this.formData.facts_content.length > 10;
            } else if (editorId === 'fundamentos') {
                return this.formData.fundamentos_content && this.formData.fundamentos_content.length > 10;
            } else if (editorId === 'pedidos') {
                return this.formData.pedidos_content && this.formData.pedidos_content.length > 10;
            }
            return false;
        },
        
        isFormValid() {
            const hasSpouseNames = this.formData.spouse_one_name && 
                                   this.formData.spouse_one_name.trim().length >= 3 &&
                                   this.formData.spouse_two_name && 
                                   this.formData.spouse_two_name.trim().length >= 3;
            
            const hasFacts = this.formData.facts_content && this.formData.facts_content.length > 10;
            const hasFundamentos = this.formData.fundamentos_content && this.formData.fundamentos_content.length > 10;
            const hasPedidos = this.formData.pedidos_content && this.formData.pedidos_content.length > 10;
            
            const noErrors = Object.keys(this.errors).length === 0;
            
            return hasSpouseNames && hasFacts && hasFundamentos && hasPedidos && noErrors;
        },
        
        handleFiles(event) {
            this.selectedFiles = Array.from(event.target.files);
            this.markDirty();
        },
        
        formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        },
        
        async autoSave() {
            this.autoSaveStatus = 'saving';
            
            try {
                const factsTextarea = document.getElementById('facts');
                const fundamentosTextarea = document.getElementById('fundamentos');
                const pedidosTextarea = document.getElementById('pedidos');
                
                const draftData = {
                    ...this.formData,
                    template_id: this.selectedTemplate,
                    facts: factsTextarea._quill?.root.innerHTML || factsTextarea.value || '',
                    fundamentos: fundamentosTextarea._quill?.root.innerHTML || fundamentosTextarea.value || '',
                    pedidos: pedidosTextarea._quill?.root.innerHTML || pedidosTextarea.value || '',
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('petition_draft_family', JSON.stringify(draftData));
                
                this.autoSaveStatus = 'saved';
                this.isDirty = false;
                
                setTimeout(() => { this.autoSaveStatus = 'idle'; }, 2000);
                
            } catch (error) {
                console.error('Auto-save error:', error);
                this.autoSaveStatus = 'error';
                setTimeout(() => { this.autoSaveStatus = 'idle'; }, 3000);
            }
        },
        
        async saveAsDraft() {
            await this.autoSave();
            window.showToast('Rascunho salvo com sucesso!', 'success');
        },
        
        async submitForm(event) {
            // Sincroniza Quill para textareas
            document.querySelectorAll('.petition-editor').forEach(textarea => {
                if (textarea._quill) {
                    textarea.value = textarea._quill.root.innerHTML;
                }
            });
            
            this.validateField('spouse_one_name');
            this.validateField('spouse_two_name');
            
            if (!this.isFormValid()) {
                window.showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }
            
            this.submitting = true;
            event.target.submit();
        }
    }
}
</script>
{% endblock %}
