{% extends "base.html" %}

{% block styles %}
<style>
    /* Estilos para o editor de variáveis */
    .variable-legend {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .variable-legend h6 {
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    .variable-badge {
        display: inline-block;
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 2px 8px;
        margin: 2px;
        font-family: monospace;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .variable-badge:hover {
        background: #ffc107;
        color: #000;
    }
    .ql-container {
        border-radius: 0 0 4px 4px !important;
        font-family: 'Times New Roman', Times, serif;
        font-size: 12pt;
    }
    .ql-toolbar {
        border-radius: 4px 4px 0 0 !important;
        background: #f8f9fa;
    }
    .ql-editor {
        min-height: 400px;
        line-height: 1.5;
    }
    .ql-editor-small .ql-editor {
        min-height: 150px;
    }
</style>
{% endblock %}

{% block content %}
{% set icon_class = page_icon or 'fas fa-pen-to-square' %}
{% if page_subtitle %}
    {% set subtitle_text = page_subtitle %}
{% elif template %}
    {% set subtitle_text = 'Atualize o conteúdo e os metadados de "' ~ template.name ~ '".' %}
{% else %}
    {% set subtitle_text = 'Preencha todos os campos para disponibilizar este modelo.' %}
{% endif %}
{% set back_href = back_url or (template and url_for('petitions.view_template', template_id=template.id)) or url_for('petitions.civil_petitions') %}
{% set submit_text = submit_label or 'Salvar modelo' %}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="{{ icon_class }}"></i> {{ page_title or 'Editar modelo' }}</h1>
            <p class="text-muted mb-0">{{ subtitle_text }}</p>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <a href="{{ back_href }}" class="btn btn-sm btn-outline-secondary d-flex align-items-center">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <strong>Dados do modelo</strong>
                </div>
                <div class="card-body">
                    <form method="post">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.name.label(class_='form-label') }}
                            {{ form.name(class_='form-control') }}
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.category.label(class_='form-label') }}
                                {{ form.category(class_='form-select') }}
                            </div>
                            <div class="col-md-6">
                                {{ form.petition_type_id.label(class_='form-label') }}
                                {{ form.petition_type_id(class_='form-select') }}
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            {{ form.description.label(class_='form-label') }}
                            {{ form.description(class_='form-control') }}
                        </div>
                        
                        <!-- Legenda de variáveis disponíveis -->
                        <div class="variable-legend mb-3">
                            <h6><i class="fas fa-code text-primary me-2"></i>Variáveis Disponíveis</h6>
                            <p class="text-muted small mb-2">Clique em uma variável para copiá-la ou use o botão "Inserir Campo" no editor.</p>
                            <div id="variablesList">
                                <!-- Preenchido pelo JavaScript baseado na categoria -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.content.label(class_='form-label') }}
                            <div id="template-content-editor-container"></div>
                            {{ form.content(class_='form-control d-none', id='template-content-editor') }}
                            <small class="text-muted">Use o editor acima para formatar o texto. Clique nas variáveis acima para copiá-las e cole no editor. <a href="{{ url_for('petitions.template_examples') }}" class="text-decoration-underline">Ver exemplos</a>.</small>
                        </div>
                        
                        <hr class="my-4">
                        <h5 class="mb-3"><i class="fas fa-magic text-primary me-2"></i>Textos Padrão (Pré-preenchimento)</h5>
                        <p class="text-muted small mb-3">
                            Defina textos padrão que serão carregados automaticamente nos campos do formulário quando este modelo for selecionado. 
                            Isso agiliza o preenchimento das petições.
                        </p>
                        
                        <div class="mb-3">
                            {{ form.default_facts.label(class_='form-label') }}
                            {{ form.default_facts(class_='form-control', id='default-facts-editor') }}
                            <small class="text-muted">Este texto será carregado no campo "Fatos" quando o usuário selecionar este modelo.</small>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.default_fundamentos.label(class_='form-label') }}
                            {{ form.default_fundamentos(class_='form-control', id='default-fundamentos-editor') }}
                            <small class="text-muted">Este texto será carregado no campo "Fundamentação Jurídica" quando o usuário selecionar este modelo.</small>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.default_pedidos.label(class_='form-label') }}
                            {{ form.default_pedidos(class_='form-control', id='default-pedidos-editor') }}
                            <small class="text-muted">Este texto será carregado no campo "Pedidos" quando o usuário selecionar este modelo.</small>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="form-check form-switch mb-3">
                            {{ form.is_active(class_='form-check-input') }}
                            {{ form.is_active.label(class_='form-check-label') }}
                        </div>
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-save"></i> {{ submit_text }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtém a categoria atual
    const categorySelect = document.getElementById('category');
    let currentCategory = categorySelect ? categorySelect.value : 'civel';
    
    // Armazena referências aos editores Quill
    let contentEditor = null;
    let factsEditor = null;
    let fundamentosEditor = null;
    let pedidosEditor = null;
    
    // Função para obter variáveis baseado na categoria
    function getVariablesForCategory(category) {
        if (category === 'familia') {
            return PetitioEditor.FAMILY_VARIABLES;
        }
        return PetitioEditor.CIVIL_VARIABLES;
    }
    
    // Renderiza a lista de variáveis
    function renderVariablesList(category) {
        const container = document.getElementById('variablesList');
        const variables = getVariablesForCategory(category);
        
        container.innerHTML = variables.map(function(v) {
            return '<span class="variable-badge" data-variable="' + v.value + '" title="Clique para copiar">' + v.value + '</span>';
        }).join(' ');
        
        // Adiciona evento de clique para copiar
        container.querySelectorAll('.variable-badge').forEach(function(badge) {
            badge.addEventListener('click', function() {
                const variable = this.dataset.variable;
                navigator.clipboard.writeText(variable).then(function() {
                    // Feedback visual
                    badge.style.background = '#28a745';
                    badge.style.color = '#fff';
                    setTimeout(function() {
                        badge.style.background = '';
                        badge.style.color = '';
                    }, 500);
                });
            });
        });
    }
    
    // Renderiza inicialmente
    renderVariablesList(currentCategory);
    
    // Atualiza quando categoria muda
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            currentCategory = this.value;
            renderVariablesList(currentCategory);
        });
    }
    
    // Configuração da toolbar do Quill
    const toolbarOptions = [
        [{ 'header': [1, 2, 3, 4, false] }],
        [{ 'font': [] }],
        [{ 'size': ['small', false, 'large', 'huge'] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'align': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        ['blockquote'],
        ['clean']
    ];
    
    const simpleToolbarOptions = [
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['clean']
    ];
    
    // Inicializa o editor principal de conteúdo
    const contentEditorContainer = document.getElementById('template-content-editor-container');
    const contentHidden = document.getElementById('template-content-editor');
    
    if (contentEditorContainer) {
        contentEditor = new Quill(contentEditorContainer, {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions
            },
            placeholder: 'Digite o conteúdo do modelo de petição...'
        });
        
        // Carrega conteúdo existente
        if (contentHidden && contentHidden.value) {
            contentEditor.clipboard.dangerouslyPasteHTML(contentHidden.value);
        }
        
        // Sincroniza com o campo hidden
        contentEditor.on('text-change', function() {
            if (contentHidden) {
                contentHidden.value = contentEditor.root.innerHTML;
            }
        });
    }
    
    // Inicializa editores de textos padrão (mais simples)
    const factsHidden = document.getElementById('default-facts-editor');
    const fundamentosHidden = document.getElementById('default-fundamentos-editor');
    const pedidosHidden = document.getElementById('default-pedidos-editor');
    
    // Cria containers para os editores
    function createEditorContainer(hiddenField) {
        if (!hiddenField) return null;
        
        const container = document.createElement('div');
        container.className = 'ql-editor-small';
        hiddenField.parentNode.insertBefore(container, hiddenField);
        hiddenField.classList.add('d-none');
        
        const editor = new Quill(container, {
            theme: 'snow',
            modules: {
                toolbar: simpleToolbarOptions
            },
            placeholder: 'Digite o texto padrão...'
        });
        
        // Carrega conteúdo existente
        if (hiddenField.value) {
            editor.clipboard.dangerouslyPasteHTML(hiddenField.value);
        }
        
        // Sincroniza com o campo hidden
        editor.on('text-change', function() {
            hiddenField.value = editor.root.innerHTML;
        });
        
        return editor;
    }
    
    factsEditor = createEditorContainer(factsHidden);
    fundamentosEditor = createEditorContainer(fundamentosHidden);
    pedidosEditor = createEditorContainer(pedidosHidden);
    
    // Sincroniza os editores antes do envio do formulário
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            if (contentEditor && contentHidden) {
                contentHidden.value = contentEditor.root.innerHTML;
            }
            if (factsEditor && factsHidden) {
                factsHidden.value = factsEditor.root.innerHTML;
            }
            if (fundamentosEditor && fundamentosHidden) {
                fundamentosHidden.value = fundamentosEditor.root.innerHTML;
            }
            if (pedidosEditor && pedidosHidden) {
                pedidosHidden.value = pedidosEditor.root.innerHTML;
            }
        });
    }
});
</script>
{% endblock %}
