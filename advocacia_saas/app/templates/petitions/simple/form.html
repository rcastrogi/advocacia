{% extends "base.html" %}
{% block title %}{{ title }} - Peticionador{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<style>
    .template-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    .template-card:hover {
        border-color: var(--bs-primary);
        transform: translateY(-2px);
    }
    .template-card.selected {
        border-color: var(--bs-primary);
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    .section-header {
        cursor: pointer;
        user-select: none;
    }
    .section-header:hover {
        background-color: rgba(0,0,0,0.02);
    }
    .field-valid { border-color: #198754 !important; }
    .field-invalid { border-color: #dc3545 !important; }
    .ql-editor {
        min-height: 120px;
        font-size: 14px;
    }
    .required-indicator::after {
        content: ' *';
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" x-data="simplePetitionForm()">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-file-alt me-2 text-primary"></i>{{ title }}</h2>
                    <p class="text-muted mb-0">Petições de juntada, MLE e requerimentos simples.</p>
                </div>
                <div>
                    <a href="{{ url_for('petitions.index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Formulário Principal -->
        <div class="col-lg-9">
            <form method="POST" enctype="multipart/form-data" @submit.prevent="submitForm($event)">
                {{ form.hidden_tag() }}
                {{ form.template_id(id='template_id') }}

                <!-- Modelo -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-file-contract me-2"></i>Selecionar Modelo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            {% for template in templates %}
                            <div class="col-md-6">
                                <div class="card template-card h-100" 
                                     :class="{ 'selected': selectedTemplate == {{ template.id }} }"
                                     @click="selectTemplate({{ template.id }})">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start">
                                            <div class="form-check">
                                                <input type="radio" 
                                                       class="form-check-input" 
                                                       name="template_radio"
                                                       :checked="selectedTemplate == {{ template.id }}">
                                            </div>
                                            <div class="ms-2">
                                                <h6 class="mb-1">{{ template.name }}</h6>
                                                {% if template.description %}
                                                <small class="text-muted">{{ template.description }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Dados do Processo -->
                <div class="card mb-4">
                    <div class="card-header section-header" @click="sections.processo = !sections.processo">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-gavel me-2"></i>Dados do Processo</h5>
                            <i class="fas" :class="sections.processo ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                    </div>
                    <div class="card-body" x-show="sections.processo" x-transition>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">{{ form.forum.label }}</label>
                                {{ form.forum(class_='form-control', **{'x-model': 'formData.forum'}) }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.vara.label }}</label>
                                {{ form.vara(class_='form-control', **{'x-model': 'formData.vara'}) }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required-indicator">{{ form.process_number.label }}</label>
                                {{ form.process_number(class_='form-control', **{'x-model': 'formData.process_number', '@blur': 'validateField("process_number")', ':class': 'getFieldClass("process_number")'}) }}
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">{{ form.action_type.label }}</label>
                                {{ form.action_type(class_='form-control', **{'x-model': 'formData.action_type'}) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Partes -->
                <div class="card mb-4">
                    <div class="card-header section-header" @click="sections.partes = !sections.partes">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Partes</h5>
                            <i class="fas" :class="sections.partes ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                    </div>
                    <div class="card-body" x-show="sections.partes" x-transition>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required-indicator">{{ form.author_name.label }}</label>
                                {{ form.author_name(class_='form-control', **{'x-model': 'formData.author_name', '@blur': 'validateField("author_name")', ':class': 'getFieldClass("author_name")'}) }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.defendant_name.label }}</label>
                                {{ form.defendant_name(class_='form-control', **{'x-model': 'formData.defendant_name'}) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dados do Levantamento (MLE) -->
                <div class="card mb-4" x-show="isMLE() && !isPenhoraINSS()">
                    <div class="card-header section-header bg-success text-white" @click="sections.mle = !sections.mle">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Dados do Levantamento (MLE)</h5>
                            <i class="fas text-white" :class="sections.mle ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                    </div>
                    <div class="card-body" x-show="sections.mle" x-transition>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">{{ form.valor_levantamento.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.valor_levantamento(class_='form-control', **{'x-model': 'formData.valor_levantamento'}) }}
                                </div>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">{{ form.valor_extenso.label }}</label>
                                {{ form.valor_extenso(class_='form-control', **{'x-model': 'formData.valor_extenso'}) }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">{{ form.folhas_referencia.label }}</label>
                                {{ form.folhas_referencia(class_='form-control', **{'x-model': 'formData.folhas_referencia'}) }}
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h6 class="text-muted mb-3"><i class="fas fa-university me-2"></i>Dados para Crédito</h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.pix_chave.label }}</label>
                                {{ form.pix_chave(class_='form-control', **{'x-model': 'formData.pix_chave'}) }}
                                <small class="text-muted">CPF, e-mail, telefone ou chave aleatória</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.banco_dados.label }}</label>
                                {{ form.banco_dados(class_='form-control', **{'x-model': 'formData.banco_dados'}) }}
                                <small class="text-muted">Alternativo ao PIX</small>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">{{ form.titular_conta.label }}</label>
                                {{ form.titular_conta(class_='form-control', **{'x-model': 'formData.titular_conta'}) }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ form.procuracao_folha.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">fl.</span>
                                    {{ form.procuracao_folha(class_='form-control', **{'x-model': 'formData.procuracao_folha'}) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dados da Penhora INSS -->
                <div class="card mb-4" x-show="isPenhoraINSS()">
                    <div class="card-header section-header bg-warning text-dark" @click="sections.penhora = !sections.penhora">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Dados da Penhora de Benefício INSS</h5>
                            <i class="fas" :class="sections.penhora ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                    </div>
                    <div class="card-body" x-show="sections.penhora" x-transition>
                        <div class="alert alert-info small mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Penhora de Benefício INSS:</strong> Preencha os dados do benefício previdenciário e os valores de penhora.
                        </div>
                        
                        <h6 class="text-muted mb-3"><i class="fas fa-file-invoice-dollar me-2"></i>Benefício do Executado</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Valor do Benefício INSS</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.valor_beneficio_inss(class_='form-control', **{'x-model': 'formData.valor_beneficio_inss'}) }}
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Valor por extenso</label>
                                {{ form.valor_beneficio_extenso(class_='form-control', **{'x-model': 'formData.valor_beneficio_extenso'}) }}
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h6 class="text-muted mb-3"><i class="fas fa-percentage me-2"></i>Penhora Requerida</h6>
                        
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Percentual de penhora</label>
                                {{ form.percentual_penhora(class_='form-control', **{'x-model': 'formData.percentual_penhora'}) }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Valor mensal a penhorar</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.valor_penhora(class_='form-control', **{'x-model': 'formData.valor_penhora'}) }}
                                </div>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Valor por extenso</label>
                                {{ form.valor_penhora_extenso(class_='form-control', **{'x-model': 'formData.valor_penhora_extenso'}) }}
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h6 class="text-muted mb-3"><i class="fas fa-calculator me-2"></i>Débito Total e Prazo</h6>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Débito atualizado total</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.debito_atualizado(class_='form-control', **{'x-model': 'formData.debito_atualizado'}) }}
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Débito por extenso</label>
                                {{ form.debito_extenso(class_='form-control', **{'x-model': 'formData.debito_extenso'}) }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Qtd. parcelas estimadas</label>
                                <div class="input-group">
                                    {{ form.qtd_parcelas(class_='form-control', **{'x-model': 'formData.qtd_parcelas'}) }}
                                    <span class="input-group-text">parcelas</span>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Tempo de inadimplência</label>
                                {{ form.tempo_inadimplencia(class_='form-control', **{'x-model': 'formData.tempo_inadimplencia'}) }}
                                <small class="text-muted">Ex: 9 (nove) anos desde a sentença</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo -->
                <div class="card mb-4">
                    <div class="card-header section-header" @click="sections.conteudo = !sections.conteudo">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Conteúdo</h5>
                            <i class="fas" :class="sections.conteudo ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                    </div>
                    <div class="card-body" x-show="sections.conteudo" x-transition>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">{{ form.facts.label }}</label>
                                <div id="facts-editor"></div>
                                {{ form.facts(class_='d-none petition-editor', id='facts') }}
                            </div>
                            <div class="col-12">
                                <label class="form-label">{{ form.pedidos.label }}</label>
                                <div id="pedidos-editor"></div>
                                {{ form.pedidos(class_='d-none petition-editor', id='pedidos') }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assinatura e Anexos -->
                <div class="card mb-4">
                    <div class="card-header section-header" @click="sections.assinatura = !sections.assinatura">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-signature me-2"></i>Assinatura e Anexos</h5>
                            <i class="fas" :class="sections.assinatura ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                    </div>
                    <div class="card-body" x-show="sections.assinatura" x-transition>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.cidade.label }}</label>
                                {{ form.cidade(class_='form-control', **{'x-model': 'formData.cidade'}) }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.data_assinatura.label }}</label>
                                {{ form.data_assinatura(class_='form-control', **{'x-model': 'formData.data_assinatura'}) }}
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-12">
                                <div class="alert alert-info mb-0 py-2">
                                    <i class="fas fa-user-tie me-2"></i>
                                    <strong>Advogado:</strong> {{ form.advogado_nome.data }} - <strong>OAB:</strong> {{ form.advogado_oab.data }}
                                    <small class="text-muted ms-2">(dados do perfil)</small>
                                </div>
                                {{ form.advogado_nome(type='hidden') }}
                                {{ form.advogado_oab(type='hidden') }}
                            </div>
                        </div>
                        
                        <hr class="my-3">
                        <h6 class="text-muted mb-3"><i class="fas fa-paperclip me-2"></i>Documentos Anexos</h6>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">{{ form.documents.label }}</label>
                                {{ form.documents(class_='form-control', **{'@change': 'handleFiles($event)'}) }}
                                <small class="text-muted">Anexe o MLE e outros documentos necessários. Até 5 arquivos (pdf, doc, docx, png, jpg) com 5 MB cada.</small>
                            </div>
                        </div>

                        <!-- Lista de arquivos selecionados -->
                        <div class="mt-3" x-show="selectedFiles.length > 0">
                            <label class="form-label small text-muted">Arquivos selecionados:</label>
                            <ul class="list-group list-group-flush small">
                                <template x-for="(file, index) in selectedFiles" :key="index">
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                                        <span><i class="fas fa-file me-2"></i><span x-text="file.name"></span></span>
                                        <span class="badge bg-secondary" x-text="formatFileSize(file.size)"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Botões de ação -->
                <div class="card">
                    <div class="card-body">
                        <!-- Validação visual -->
                        <div class="alert alert-light border mb-3" x-show="!isFormValid()" x-transition>
                            <h6 class="alert-heading mb-2">
                                <i class="fas fa-exclamation-circle text-warning me-1"></i>
                                Preencha os campos obrigatórios:
                            </h6>
                            <ul class="mb-0 small">
                                <li :class="formData.process_number ? 'text-success' : 'text-danger'">
                                    <i :class="formData.process_number ? 'fas fa-check' : 'fas fa-times'"></i>
                                    Número do Processo
                                </li>
                                <li :class="formData.author_name ? 'text-success' : 'text-danger'">
                                    <i :class="formData.author_name ? 'fas fa-check' : 'fas fa-times'"></i>
                                    Nome do Autor
                                </li>
                            </ul>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div></div>
                            <div class="d-flex gap-2">
                                <button type="submit" 
                                        class="btn btn-lg btn-primary"
                                        :disabled="submitting || !isFormValid()"
                                        :class="{ 'opacity-50': !isFormValid() }">
                                    <span x-show="!submitting">
                                        <i class="fas fa-file-pdf me-1"></i> Gerar PDF
                                    </span>
                                    <span x-show="submitting">
                                        <i class="fas fa-spinner fa-spin me-1"></i> Gerando...
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="card sticky-top" style="top: 80px;">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Dicas</h6>
                </div>
                <div class="card-body small">
                    <p><strong>Petição de Juntada de MLE:</strong></p>
                    <ul class="ps-3">
                        <li>Informe o número do processo corretamente</li>
                        <li>Preencha o valor a ser levantado</li>
                        <li>Indique a chave PIX ou dados bancários</li>
                        <li>Anexe o MLE (Mandado de Levantamento Eletrônico)</li>
                    </ul>
                    <hr>
                    <p class="text-muted mb-0">
                        <i class="fas fa-lightbulb me-1"></i>
                        Os campos não preenchidos usarão valores padrão.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script>
function simplePetitionForm() {
    return {
        selectedTemplate: {{ form.template_id.data or (templates[0].id if templates else 0) }},
        submitting: false,
        selectedFiles: [],
        
        sections: {
            processo: true,
            partes: true,
            mle: true,
            penhora: true,
            conteudo: true,
            assinatura: true
        },
        
        // IDs dos templates (ajustar conforme banco de dados)
        templatePenhoraINSS: 0, // Será definido via data attribute
        
        formData: {
            process_number: '{{ form.process_number.data or "" }}',
            author_name: '{{ form.author_name.data or "" }}',
            defendant_name: '{{ form.defendant_name.data or "" }}',
            forum: '{{ form.forum.data or "" }}',
            vara: '{{ form.vara.data or "" }}',
            action_type: '{{ form.action_type.data or "" }}',
            valor_levantamento: '{{ form.valor_levantamento.data or "" }}',
            valor_extenso: '{{ form.valor_extenso.data or "" }}',
            folhas_referencia: '{{ form.folhas_referencia.data or "" }}',
            pix_chave: '{{ form.pix_chave.data or "" }}',
            banco_dados: '{{ form.banco_dados.data or "" }}',
            titular_conta: '{{ form.titular_conta.data or "" }}',
            procuracao_folha: '{{ form.procuracao_folha.data or "" }}',
            // Campos de Penhora INSS
            valor_beneficio_inss: '{{ form.valor_beneficio_inss.data or "" }}',
            valor_beneficio_extenso: '{{ form.valor_beneficio_extenso.data or "" }}',
            percentual_penhora: '{{ form.percentual_penhora.data or "" }}',
            valor_penhora: '{{ form.valor_penhora.data or "" }}',
            valor_penhora_extenso: '{{ form.valor_penhora_extenso.data or "" }}',
            debito_atualizado: '{{ form.debito_atualizado.data or "" }}',
            debito_extenso: '{{ form.debito_extenso.data or "" }}',
            qtd_parcelas: '{{ form.qtd_parcelas.data or "" }}',
            tempo_inadimplencia: '{{ form.tempo_inadimplencia.data or "" }}',
            cidade: '{{ form.cidade.data or "" }}',
            data_assinatura: '{{ form.data_assinatura.data or "" }}'
        },
        
        errors: {},
        touched: {},
        
        init() {
            this.initEditors();
            // Detectar template de Penhora INSS pelo nome
            this.detectTemplateTypes();
        },
        
        detectTemplateTypes() {
            // Detectar IDs dos templates especiais
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                const templateName = card.querySelector('h6')?.textContent?.toLowerCase() || '';
                if (templateName.includes('penhora') && templateName.includes('inss')) {
                    // Extrair o ID do template do atributo @click
                    const clickAttr = card.getAttribute('@click');
                    if (clickAttr) {
                        const match = clickAttr.match(/selectTemplate\((\d+)\)/);
                        if (match) {
                            this.templatePenhoraINSS = parseInt(match[1]);
                        }
                    }
                }
            });
        },
        
        isPenhoraINSS() {
            // Verifica se o template selecionado é de Penhora INSS
            if (this.templatePenhoraINSS > 0) {
                return this.selectedTemplate === this.templatePenhoraINSS;
            }
            // Fallback: verificar pelo nome do template selecionado
            const selectedCard = document.querySelector('.template-card.selected h6');
            if (selectedCard) {
                const name = selectedCard.textContent.toLowerCase();
                return name.includes('penhora') && name.includes('inss');
            }
            return false;
        },
        
        isMLE() {
            // Verifica se o template selecionado é de MLE
            const selectedCard = document.querySelector('.template-card.selected h6');
            if (selectedCard) {
                const name = selectedCard.textContent.toLowerCase();
                return name.includes('mle') || name.includes('levantamento');
            }
            return true; // Default: mostrar seção MLE
        },
        
        initEditors() {
            const self = this;
            
            // Editor de Fatos
            const factsEditor = new Quill('#facts-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Descreva o motivo do requerimento...'
            });
            
            const factsTextarea = document.getElementById('facts');
            if (factsTextarea.value) {
                factsEditor.root.innerHTML = factsTextarea.value;
            }
            factsEditor.on('text-change', function() {
                factsTextarea.value = factsEditor.root.innerHTML;
            });
            
            // Editor de Pedidos
            const pedidosEditor = new Quill('#pedidos-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Liste os pedidos...'
            });
            
            const pedidosTextarea = document.getElementById('pedidos');
            if (pedidosTextarea.value) {
                pedidosEditor.root.innerHTML = pedidosTextarea.value;
            }
            pedidosEditor.on('text-change', function() {
                pedidosTextarea.value = pedidosEditor.root.innerHTML;
            });
        },
        
        selectTemplate(templateId) {
            this.selectedTemplate = templateId;
            document.getElementById('template_id').value = templateId;
        },
        
        validateField(fieldName) {
            this.touched[fieldName] = true;
            const value = this.formData[fieldName];
            
            switch(fieldName) {
                case 'process_number':
                    if (!value || value.trim().length < 5) {
                        this.errors[fieldName] = 'Número do processo inválido';
                    } else {
                        delete this.errors[fieldName];
                    }
                    break;
                case 'author_name':
                    if (!value || value.trim().length < 3) {
                        this.errors[fieldName] = 'Nome deve ter pelo menos 3 caracteres';
                    } else {
                        delete this.errors[fieldName];
                    }
                    break;
            }
        },
        
        getFieldClass(fieldName) {
            if (!this.touched[fieldName]) return 'form-control';
            if (this.errors[fieldName]) return 'form-control field-invalid';
            if (this.formData[fieldName]) return 'form-control field-valid';
            return 'form-control';
        },
        
        isFormValid() {
            return this.formData.process_number && 
                   this.formData.process_number.trim().length >= 5 &&
                   this.formData.author_name && 
                   this.formData.author_name.trim().length >= 3 &&
                   Object.keys(this.errors).length === 0;
        },
        
        handleFiles(event) {
            this.selectedFiles = Array.from(event.target.files);
        },
        
        formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        },
        
        async submitForm(event) {
            this.validateField('process_number');
            this.validateField('author_name');
            
            if (!this.isFormValid()) {
                window.showToast && window.showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }
            
            this.submitting = true;
            event.target.submit();
        }
    }
}
</script>
{% endblock %}
