{% extends "base.html" %}

{% block styles %}
<style>
    /* Quill Editor Styles */
    .quill-wrapper {
        border: 1px solid #ced4da;
        border-radius: 4px;
        overflow: hidden;
    }
    .quill-wrapper .ql-toolbar {
        border: none !important;
        border-bottom: 1px solid #ced4da !important;
        background: #f8f9fa;
    }
    .quill-wrapper .ql-container {
        border: none !important;
        min-height: 250px;
        font-size: 1rem;
    }
    .quill-wrapper .ql-editor {
        min-height: 250px;
        max-height: 500px;
        overflow-y: auto;
    }
    .quill-wrapper .ql-editor.ql-blank::before {
        font-style: italic;
        color: #6c757d;
    }
    .ql-container { border-radius: 0 0 4px 4px !important; }
    .ql-toolbar { border-radius: 4px 4px 0 0 !important; }
    
    /* Indicadores de validação */
    .field-valid { border-color: #198754 !important; }
    .field-invalid { border-color: #dc3545 !important; }
    .field-warning { border-color: #ffc107 !important; }
    
    /* Auto-save indicator */
    .auto-save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    .auto-save-indicator.saving { background: #ffc107; color: #000; }
    .auto-save-indicator.saved { background: #198754; color: #fff; }
    .auto-save-indicator.error { background: #dc3545; color: #fff; }
    
    /* Seções colapsáveis */
    .section-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    .section-header {
        cursor: pointer;
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
        border-bottom: 1px solid #e0e0e0;
        user-select: none;
        transition: background 0.2s;
    }
    .section-header:hover {
        background: linear-gradient(135deg, #f0f0f0 0%, #fff 100%);
    }
    .section-header .section-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }
    .section-body {
        padding: 1.25rem;
        background: #fff;
    }
    .section-required::after {
        content: ' *';
        color: #dc3545;
    }
    
    /* Indicador de campo obrigatório no label */
    label.required::after,
    .form-label.required::after {
        content: ' *';
        color: #dc3545;
        font-weight: bold;
    }
    
    /* Chevron animado */
    .chevron-icon {
        transition: transform 0.3s ease;
    }
    
    /* Campos de endereço otimizados */
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 0.35rem;
    }
    
    .form-control,
    .form-select {
        font-size: 0.9rem;
        padding: 0.35rem 0.65rem;
        line-height: 1.4;
    }
    
    .input-group .form-control {
        padding: 0.35rem 0.65rem;
    }
    
    .input-group .btn {
        padding: 0.35rem 0.65rem;
        font-size: 0.85rem;
    }
    
    /* Melhorar espaçamento mínimo entre campos */
    .conditional-field {
        margin-bottom: 0.5rem;
    }
    
    /* Grid de endereço responsivo */
    .row.g-3 > [class*="col-"] {
        display: flex;
        flex-direction: column;
    }
    
    /* Em telas pequenas, todos ocupam 100% */
    @media (max-width: 768px) {
        [class*="col-md-"] {
            flex: 0 0 100% !important;
            max-width: 100% !important;
        }
    }
    .section-collapsed .chevron-icon {
        transform: rotate(-90deg);
    }
    
    /* Campos condicionais */
    .conditional-field {
        animation: fadeSlideIn 0.3s ease;
    }
    @keyframes fadeSlideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Badge de seção */
    .section-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 12px;
    }
    
    /* Estilos para toolbar de IA */
    .ai-toolbar {
        padding: 8px 12px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9f7ef 100%);
        border-radius: 8px 8px 0 0;
        border: 1px solid #e0e0e0;
        border-bottom: none;
    }
    .ai-toolbar .btn {
        font-size: 0.85rem;
    }
    .ai-toolbar + .quill-wrapper {
        border-radius: 0 0 4px 4px;
    }
    .ai-credits-indicator .alert {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dados das seções em variável global para Alpine -->
<script>
    window.PETITION_SECTIONS = {{ sections_json | safe }};
    window.PETITION_TYPE = {
        id: {{ petition_type.id }},
        slug: {{ petition_type.slug | tojson }},
        name: {{ petition_type.name | tojson }}
    };
    // Dados de edição (se houver)
    window.EDIT_PETITION = {{ edit_petition_json | safe if edit_petition_json else 'null' }};
    // Campos bloqueados (para petições pagas)
    window.LOCKED_FIELDS = {{ locked_fields | tojson }};
</script>

<div class="container py-4" 
     x-data="dynamicPetitionForm" 
     x-init="init()"
     x-cloak>

    {% if edit_petition and edit_petition.is_paid %}
    <!-- Aviso de campos bloqueados -->
    <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
        <i class="fas fa-lock me-2"></i>
        <strong>Campos bloqueados:</strong> Esta petição já foi paga. Os dados das partes (autor, réu, representantes) não podem ser alterados para garantir a integridade do processo.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
    {% endif %}
    
    <!-- Auto-save indicator -->
    <div class="auto-save-indicator" 
         x-show="autoSaveStatus !== 'idle'"
         x-transition
         :class="{
             'saving': autoSaveStatus === 'saving',
             'saved': autoSaveStatus === 'saved',
             'error': autoSaveStatus === 'error'
         }">
        <span x-show="autoSaveStatus === 'saving'">
            <i class="fas fa-circle-notch fa-spin me-1"></i> Salvando...
        </span>
        <span x-show="autoSaveStatus === 'saved'">
            <i class="fas fa-check me-1"></i> Salvo automaticamente
        </span>
        <span x-show="autoSaveStatus === 'error'">
            <i class="fas fa-exclamation-triangle me-1"></i> Erro ao salvar
        </span>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div data-tour="petition-type">
            <h1 class="h3 mb-1">
                <i class="fas {{ petition_type.icon or 'fa-file-alt' }}"></i> 
                {{ petition_type.name }}
                {% if edit_petition %}
                <span class="badge bg-warning ms-2">Editando</span>
                {% endif %}
            </h1>
            <p class="text-muted mb-0">{{ petition_type.description or 'Preencha os dados para gerar a petição.' }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('petitions.saved_list') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-folder-open me-1"></i> Minhas Petições
            </a>
            <a href="{{ url_for('main.peticionador') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
            <button type="button" class="btn btn-sm btn-primary" @click="savePetition()" :disabled="isSaving" data-tour="petition-save">
                <i class="fas fa-save me-1"></i> 
                <span x-text="isSaving ? 'Salvando...' : 'Salvar'"></span>
            </button>
        </div>
    </div>

    <!-- Barra de controle das seções -->
    <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted small">
                <i class="fas fa-layer-group me-1"></i>
                <span x-text="sections.length"></span> seções
            </span>
            <span class="text-muted small" x-show="getTotalMissingRequired() > 0">
                | <i class="fas fa-exclamation-circle text-danger me-1"></i>
                <span x-text="getTotalMissingRequired()" class="text-danger"></span> campo(s) obrigatório(s) pendente(s)
            </span>
        </div>
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary" @click="expandAllSections()" title="Expandir todas">
                <i class="fas fa-expand-alt me-1"></i> Expandir
            </button>
            <button type="button" class="btn btn-outline-secondary" @click="collapseAllSections()" title="Recolher todas">
                <i class="fas fa-compress-alt me-1"></i> Recolher
            </button>
        </div>
    </div>

    <!-- Formulário Principal -->
    <form @submit.prevent="generatePetition()" id="petition-form">
        
        <!-- Loop pelas seções configuradas -->
        {% for section_config in sections %}
        <div class="section-card" 
             :class="{ 'section-collapsed': !sectionExpanded['{{ section_config.section.slug }}'] }"
             x-show="shouldShowSection('{{ section_config.section.slug }}')"
             x-transition>
            
            <!-- Cabeçalho da Seção -->
            <div class="section-header d-flex align-items-center justify-content-between"
                 @click="toggleSection('{{ section_config.section.slug }}')">
                <div class="d-flex align-items-center gap-3">
                    <div class="section-icon bg-{{ section_config.section.color or 'primary' }} bg-opacity-10 text-{{ section_config.section.color or 'primary' }}">
                        <i class="fas {{ section_config.section.icon or 'fa-file-alt' }}"></i>
                    </div>
                    <div>
                        <h5 class="mb-0 {% if section_config.is_required %}section-required{% endif %}">
                            {{ section_config.section.name }}
                        </h5>
                        {% if section_config.section.description %}
                        <small class="text-muted">{{ section_config.section.description }}</small>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <!-- Indicador de campos obrigatórios pendentes -->
                    <span class="badge bg-danger rounded-pill" 
                          x-show="getMissingRequiredCount('{{ section_config.section.slug }}') > 0"
                          x-text="getMissingRequiredCount('{{ section_config.section.slug }}')" 
                          title="Campos obrigatórios não preenchidos">
                    </span>
                    {% if section_config.is_required %}
                    <span class="section-badge bg-danger text-white">Obrigatório</span>
                    {% endif %}
                    <i class="fas fa-chevron-down chevron-icon text-muted"></i>
                </div>
            </div>
            
            <!-- Corpo da Seção -->
            <div class="section-body" x-show="sectionExpanded['{{ section_config.section.slug }}']" x-transition>
                <div class="row g-3">
                    {% for field in section_config.section.fields_schema %}
                    <!-- Campo: {{ field.name }} -->
                    <div class="{{ field.size or 'col-12' }} conditional-field"
                         x-show="shouldShowField('{{ field.name }}', '{{ field.show_if or '' }}')"
                         x-transition>
                        
                        {% if field.type == 'text' %}
                        <!-- Campo de Texto -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="text" 
                               class="form-control {% if field.mask %}{{ field.mask }}-mask{% endif %}" 
                               name="{{ section_config.section.slug }}_{{ field.name }}"
                               x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                               placeholder="{{ field.placeholder or '' }}"
                               {% if field.required %}required aria-required="true"{% endif %}>
                        
                        {% elif field.type == 'email' %}
                        <!-- Campo de Email -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="email" 
                               class="form-control" 
                               name="{{ section_config.section.slug }}_{{ field.name }}"
                               x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                               placeholder="{{ field.placeholder or '' }}"
                               {% if field.required %}required{% endif %}>
                        
                        {% elif field.type == 'cpf' %}
                        <!-- Campo de CPF -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="text" 
                               class="form-control cpf-mask" 
                               name="{{ field.name }}"
                               x-model="formData['{{ field.name }}']"
                               placeholder="000.000.000-00"
                               {% if field.required %}required{% endif %}>
                        
                        {% elif field.type == 'cnpj' %}
                        <!-- Campo de CNPJ -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="text" 
                               class="form-control cnpj-mask" 
                               name="{{ section_config.section.slug }}_{{ field.name }}"
                               x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                               placeholder="00.000.000/0000-00"
                               {% if field.required %}required{% endif %}>
                        
                        {% elif field.type == 'cpf_cnpj' %}
                        <!-- Campo de CPF/CNPJ com validação dinâmica -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control cpf-cnpj-mask" 
                                   name="{{ section_config.section.slug }}_{{ field.name }}"
                                   x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                                   @input="formatCpfCnpj($event)"
                                   @blur="validateCpfCnpj('{{ section_config.section.slug }}_{{ field.name }}')"
                                   placeholder="CPF ou CNPJ"
                                   maxlength="18"
                                   {% if field.required %}required{% endif %}>
                            <span class="input-group-text" 
                                  x-show="cpfCnpjStatus['{{ section_config.section.slug }}_{{ field.name }}'] === 'valid'"
                                  style="color: #28a745;">
                                <i class="fas fa-check-circle"></i>
                            </span>
                            <span class="input-group-text" 
                                  x-show="cpfCnpjStatus['{{ section_config.section.slug }}_{{ field.name }}'] === 'invalid'"
                                  style="color: #dc3545;">
                                <i class="fas fa-times-circle"></i>
                            </span>
                        </div>
                        <small class="form-text" 
                               x-show="cpfCnpjStatus['{{ section_config.section.slug }}_{{ field.name }}'] === 'invalid'"
                               style="color: #dc3545;">
                            CPF ou CNPJ inválido
                        </small>
                        {% if field.linked_section_id %}
                        <small class="form-text text-info" 
                               x-show="linkedSectionTriggers['{{ section_config.section.slug }}_{{ field.name }}'] === 'cnpj'">
                            <i class="fas fa-info-circle me-1"></i>
                            Pessoa Jurídica detectada. Preencha os dados do representante legal abaixo.
                        </small>
                        {% endif %}
                        
                        {% elif field.type == 'phone' %}
                        <!-- Campo de Telefone -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="text" 
                               class="form-control phone-mask" 
                               name="{{ section_config.section.slug }}_{{ field.name }}"
                               x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                               placeholder="(00) 00000-0000"
                               {% if field.required %}required{% endif %}>
                        
                        {% elif field.type == 'cep' %}
                        <!-- Campo de CEP com busca automática -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control cep-mask" 
                                   name="{{ section_config.section.slug }}_{{ field.name }}"
                                   x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                                   @blur="buscarCEP('{{ section_config.section.slug }}_{{ field.name }}')"
                                   @keyup.enter="buscarCEP('{{ section_config.section.slug }}_{{ field.name }}')"
                                   placeholder="00000-000"
                                   {% if field.required %}required{% endif %}>
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    style="height: 37px !important; min-height: 37px !important; width: 25%; padding: 8px 0; box-sizing: border-box;"
                                    @click="buscarCEP('{{ section_config.section.slug }}_{{ field.name }}')"
                                    :disabled="cepLoading === '{{ section_config.section.slug }}_{{ field.name }}'">
                                <span x-show="cepLoading !== '{{ section_config.section.slug }}_{{ field.name }}'">
                                    <i class="fas fa-search"></i>
                                </span>
                                <span x-show="cepLoading === '{{ section_config.section.slug }}_{{ field.name }}'">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </div>
                        
                        {% elif field.type == 'date' %}
                        <!-- Campo de Data -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="date" 
                               class="form-control" 
                               name="{{ section_config.section.slug }}_{{ field.name }}"
                               x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                               {% if field.required %}required{% endif %}>
                        
                        {% elif field.type == 'number' %}
                        <!-- Campo Numérico -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="number" 
                               class="form-control" 
                               name="{{ section_config.section.slug }}_{{ field.name }}"
                               x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                               placeholder="{{ field.placeholder or '' }}"
                               {% if field.min is defined %}min="{{ field.min }}"{% endif %}
                               {% if field.max is defined %}max="{{ field.max }}"{% endif %}
                               {% if field.step %}step="{{ field.step }}"{% endif %}
                               {% if field.required %}required{% endif %}>
                        
                        {% elif field.type == 'currency' %}
                        <!-- Campo de Moeda -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" 
                                   class="form-control money-mask" 
                                   name="{{ section_config.section.slug }}_{{ field.name }}"
                                   x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                                   placeholder="{{ field.placeholder or '0,00' }}"
                                   {% if field.required %}required{% endif %}>
                        </div>
                        
                        {% elif field.type == 'select' %}
                        <!-- Campo de Seleção -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <select class="form-select" 
                                name="{{ section_config.section.slug }}_{{ field.name }}"
                                x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                                {% if field.required %}required{% endif %}>
                            <option value="">Selecione...</option>
                            {% for option in field.options %}
                            <option value="{{ option.value }}">{{ option.label }}</option>
                            {% endfor %}
                        </select>
                        
                        {% elif field.type == 'radio' %}
                        <!-- Botões de Rádio -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <div class="d-flex flex-wrap gap-3">
                            {% for option in field.options %}
                            <div class="form-check">
                                <input type="radio" 
                                       class="form-check-input" 
                                       name="{{ section_config.section.slug }}_{{ field.name }}"
                                       id="{{ section_config.section.slug }}_{{ field.name }}_{{ loop.index }}"
                                       value="{{ option.value }}"
                                       x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                                       {% if field.required %}required{% endif %}>
                                <label class="form-check-label" for="{{ section_config.section.slug }}_{{ field.name }}_{{ loop.index }}">{{ option.label }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% elif field.type == 'checkbox' %}
                        <!-- Checkbox -->
                        <div class="form-check">
                            <input type="checkbox" 
                                   class="form-check-input" 
                                   name="{{ section_config.section.slug }}_{{ field.name }}"
                                   id="{{ section_config.section.slug }}_{{ field.name }}"
                                   x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']">
                            <label class="form-check-label" for="{{ section_config.section.slug }}_{{ field.name }}">{{ field.label }}</label>
                        </div>
                        
                        {% elif field.type == 'textarea' %}
                        <!-- Área de Texto -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>

                        <textarea class="form-control"
                                  name="{{ section_config.section.slug }}_{{ field.name }}"
                                  x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                                  rows="{{ field.rows or 3 }}"
                                  placeholder="{{ field.placeholder or '' }}"
                                  {% if field.required %}required{% endif %}></textarea>
                        
                        {% elif field.type == 'editor' %}
                        <!-- Editor Rich Text (Quill) -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>

                        <div class="quill-wrapper mb-3" data-tour="petition-editor">
                            <div class="quill-editor"
                                 id="quill_{{ section_config.section.slug }}_{{ field.name }}"
                                 x-ref="editor_{{ section_config.section.slug }}_{{ field.name }}"
                                 x-init="$nextTick(() => initQuillEditor('{{ section_config.section.slug }}_{{ field.name }}'))">
                            </div>
                        </div>
                        <input type="hidden" name="{{ section_config.section.slug }}_{{ field.name }}" x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']">
                        
                        {% elif field.type == 'processo' %}
                        <!-- Campo de Número de Processo (formato CNJ) -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <input type="text" 
                               class="form-control processo-mask" 
                               name="{{ section_config.section.slug }}_{{ field.name }}"
                               x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                               placeholder="0000000-00.0000.0.00.0000"
                               {% if field.required %}required{% endif %}>
                        
                        {% elif field.type == 'estado' %}
                        <!-- Campo de Estado (UF) -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        <select class="form-select" 
                                name="{{ section_config.section.slug }}_{{ field.name }}"
                                x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']"
                                {% if field.required %}required{% endif %}>
                            <option value="">Selecione...</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                        
                        {% elif field.type == 'file' %}
                        <!-- Campo de Upload de Arquivos -->
                        <label class="form-label {% if field.required %}required{% endif %}">
                            {{ field.label }}
                            {% if field.hint %}<small class="text-muted d-block">{{ field.hint }}</small>{% endif %}
                        </label>
                        <div class="file-upload-area border-2 border-dashed rounded p-4 text-center" 
                             @drop.prevent="handleFileDrop($event, '{{ section_config.section.slug }}_{{ field.name }}')"
                             @dragover.prevent="dragover = true"
                             @dragleave.prevent="dragover = false"
                             :class="{'bg-light': dragover}">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-2">Arraste arquivos aqui ou clique para selecionar</p>
                            <input type="file" 
                                   class="form-control d-none"
                                   id="file_{{ section_config.section.slug }}_{{ field.name }}"
                                   @change="handleFileSelect($event, '{{ section_config.section.slug }}_{{ field.name }}')"
                                   accept="{{ field.accept or '.pdf,.doc,.docx,.png,.jpg,.jpeg' }}"
                                   {% if field.multiple %}multiple{% endif %}
                                   {% if field.required %}required{% endif %}>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    @click="$el.closest('.file-upload-area').querySelector('input[type=file]').click()">
                                Selecionar Arquivo
                            </button>
                        </div>
                        <!-- Lista de arquivos selecionados -->
                        <div class="mt-2" x-show="selectedFiles['{{ section_config.section.slug }}_{{ field.name }}'] && selectedFiles['{{ section_config.section.slug }}_{{ field.name }}'].length > 0">
                            <small class="text-muted">Arquivos selecionados:
                            <span x-text="'(' + ((selectedFiles['{{ section_config.section.slug }}_{{ field.name }}'] || []).reduce((sum, f) => sum + f.size, 0) / 1024 / 1024).toFixed(1) + 'MB / 50MB)'"></span>
                            </small>
                            <ul class="list-sm">
                                <template x-for="(file, index) in (selectedFiles['{{ section_config.section.slug }}_{{ field.name }}'] || [])" :key="file.name + index">
                                    <li class="small text-success d-flex justify-content-between">
                                        <span>✓ <span x-text="file.name"></span> (<span x-text="(file.size / 1024 / 1024).toFixed(2) + ' MB'"></span>)</span>
                                        <button type="button" class="btn btn-sm btn-link p-0 text-danger" @click="removeFile('{{ section_config.section.slug }}_{{ field.name }}', index)">×</button>
                                    </li>
                                </template>
                            </ul>
                        </div>
                        
                        {% elif field.type == 'fundamentos_editor' %}
                        <!-- Campo Especial: Fundamentação com Análise de Documento -->
                        <label class="form-label {% if field.required %}required{% endif %}">{{ field.label }}</label>
                        
                        <!-- Upload de Documento para Análise -->
                        <div class="card border-primary mb-3" x-data="documentAnalysis('{{ section_config.section.slug }}_{{ field.name }}')">
                            <div class="card-header bg-primary bg-opacity-10 d-flex align-items-center justify-content-between py-2">
                                <span class="fw-semibold text-primary">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Análise de Documento para Fundamentação
                                </span>
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-coins me-1"></i>4 créditos
                                </span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    Envie um documento (contrato, notificação, processo, etc.) para que a IA analise e gere uma fundamentação jurídica baseada no conteúdo.
                                </p>
                                
                                <!-- Upload Area -->
                                <div class="document-upload-area border-2 border-dashed rounded p-3 text-center mb-3"
                                     :class="{'border-success bg-success bg-opacity-10': documentFile, 'border-primary': !documentFile}"
                                     @drop.prevent="handleDocumentDrop($event)"
                                     @dragover.prevent="isDragging = true"
                                     @dragleave.prevent="isDragging = false">
                                    
                                    <template x-if="!documentFile && !isAnalyzing">
                                        <div>
                                            <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                            <p class="mb-2 small">Arraste um PDF, DOCX ou TXT aqui</p>
                                            <input type="file" 
                                                   class="d-none"
                                                   id="doc_{{ section_config.section.slug }}_{{ field.name }}"
                                                   @change="handleDocumentSelect($event)"
                                                   accept=".pdf,.docx,.txt">
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    @click="$refs.fileInput.click()">
                                                <i class="fas fa-folder-open me-1"></i>
                                                Selecionar Arquivo
                                            </button>
                                            <input type="file" x-ref="fileInput" class="d-none" 
                                                   @change="handleDocumentSelect($event)" accept=".pdf,.docx,.txt">
                                        </div>
                                    </template>
                                    
                                    <template x-if="documentFile && !isAnalyzing">
                                        <div>
                                            <i class="fas fa-file-alt fa-2x text-success mb-2"></i>
                                            <p class="mb-1 fw-semibold text-success" x-text="documentFile.name"></p>
                                            <small class="text-muted" x-text="(documentFile.size / 1024 / 1024).toFixed(2) + ' MB'"></small>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-danger me-2" @click="clearDocument()">
                                                    <i class="fas fa-times me-1"></i>Remover
                                                </button>
                                                <button type="button" class="btn btn-sm btn-success" @click="analyzeDocument()">
                                                    <i class="fas fa-magic me-1"></i>Analisar e Gerar Fundamentação
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <template x-if="isAnalyzing">
                                        <div>
                                            <div class="spinner-border text-primary mb-2" role="status">
                                                <span class="visually-hidden">Analisando...</span>
                                            </div>
                                            <p class="mb-0 text-primary fw-semibold" x-text="analyzeStatus"></p>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Análise do Documento -->
                                <template x-if="documentAnalysisResult">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0 fw-semibold">
                                                <i class="fas fa-search text-info me-1"></i>
                                                Análise do Documento
                                            </label>
                                            <button type="button" class="btn btn-sm btn-link text-muted p-0" 
                                                    @click="showAnalysis = !showAnalysis"
                                                    x-text="showAnalysis ? 'Ocultar' : 'Mostrar'"></button>
                                        </div>
                                        <div x-show="showAnalysis" x-collapse class="bg-light rounded p-3 small" 
                                             style="max-height: 200px; overflow-y: auto;">
                                            <pre class="mb-0 text-wrap" x-text="documentAnalysisResult" style="white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                </template>
                                
                                <!-- Erro -->
                                <template x-if="error">
                                    <div class="alert alert-danger py-2 small">
                                        <i class="fas fa-exclamation-circle me-1"></i>
                                        <span x-text="error"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Toolbar de IA para Melhorar Texto -->
                        <div class="ai-toolbar d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex gap-2 flex-wrap">
                                <span class="text-muted small align-self-center me-2">
                                    <i class="fas fa-lightbulb text-warning me-1"></i>
                                    Escreva sua fundamentação ou use a IA:
                                </span>
                                <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="window.PetitionForm?.improveContent('{{ section_config.section.slug }}_{{ field.name }}')">
                                    <i class="fas fa-edit me-1"></i> Melhorar Texto
                                    <span class="badge bg-secondary ms-1">1 crédito</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success"
                                        onclick="window.PetitionForm?.generateAIContent('{{ section_config.section.slug }}_{{ field.name }}')">
                                    <i class="fas fa-magic me-1"></i> Gerar Fundamentação
                                    <span class="badge bg-success bg-opacity-25 text-success ms-1">3 créditos</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Editor de Fundamentação -->
                        <div class="quill-wrapper mb-3">
                            <div class="quill-editor"
                                 id="quill_{{ section_config.section.slug }}_{{ field.name }}"
                                 x-ref="editor_{{ section_config.section.slug }}_{{ field.name }}"
                                 x-init="$nextTick(() => initQuillEditor('{{ section_config.section.slug }}_{{ field.name }}'))">
                            </div>
                        </div>
                        <input type="hidden" name="{{ section_config.section.slug }}_{{ field.name }}" x-model="formData['{{ section_config.section.slug }}_{{ field.name }}']">
                        
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Seção de Anexos (visível após salvar a petição) -->
        <div class="section-card" 
             x-show="petitionId"
             x-transition>
            
            <div class="section-header d-flex align-items-center justify-content-between"
                 @click="sectionExpanded.attachments = !sectionExpanded.attachments">
                <div class="d-flex align-items-center gap-3">
                    <div class="section-icon bg-info bg-opacity-10 text-info">
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Documentos e Provas</h5>
                        <small class="text-muted">Anexe documentos relacionados ao caso</small>
                    </div>
                </div>
                <i class="fas fa-chevron-down section-toggle-icon" 
                   :class="{ 'rotated': sectionExpanded.attachments }"></i>
            </div>
            
            <div class="section-content p-4" x-show="sectionExpanded.attachments !== false">
                <!-- Upload de arquivos -->
                <div class="mb-4">
                    <label class="form-label">Adicionar arquivos</label>
                    <div class="border border-2 border-dashed rounded p-4 text-center" 
                         id="dropzone"
                         @dragover.prevent="isDragging = true"
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleDrop($event)"
                         :class="{'bg-light': isDragging}">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                        <p class="mb-2">Arraste arquivos aqui ou</p>
                        <label class="btn btn-outline-primary">
                            <i class="fas fa-folder-open me-1"></i> Selecione arquivos
                            <input type="file" 
                                   multiple 
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                   @change="uploadFiles($event.target.files)"
                                   class="d-none">
                        </label>
                        <p class="small text-muted mt-2 mb-0">
                            PDF, DOC, DOCX, JPG, PNG (máx. 10MB por arquivo)
                        </p>
                    </div>
                </div>
                
                <!-- Lista de anexos -->
                <div x-show="attachments.length > 0">
                    <h6 class="mb-3">Arquivos anexados (<span x-text="attachments.length"></span>)</h6>
                    <div class="list-group">
                        <template x-for="attachment in attachments" :key="attachment.id">
                            <div class="list-group-item d-flex align-items-center gap-3">
                                <i class="fas fa-file text-muted fa-lg"></i>
                                <div class="flex-grow-1">
                                    <span x-text="attachment.filename" class="fw-medium"></span>
                                    <br>
                                    <small class="text-muted">
                                        <span x-text="attachment.file_size_display"></span>
                                        <span class="mx-1">•</span>
                                        <span x-text="attachment.uploaded_at"></span>
                                    </small>
                                </div>
                                <div class="btn-group">
                                    <a :href="'/petitions/attachments/' + attachment.id + '/download'" 
                                       class="btn btn-sm btn-outline-primary" title="Download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger"
                                            @click="deleteAttachment(attachment.id)"
                                            title="Remover">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Mensagem quando não há anexos -->
                <div x-show="attachments.length === 0" class="text-center text-muted py-4">
                    <i class="fas fa-file-upload fa-2x mb-2"></i>
                    <p class="mb-0">Nenhum arquivo anexado ainda.</p>
                </div>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div class="d-flex justify-content-between align-items-center mt-4 mb-5">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" @click="clearForm()">
                    <i class="fas fa-eraser me-1"></i> Limpar
                </button>
                <a href="{{ url_for('petitions.saved_list') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-folder-open me-1"></i> Minhas Petições
                </a>
            </div>
            
            <div class="d-flex gap-2">
                <!-- Botão Salvar -->
                <button type="button" class="btn btn-outline-success" @click="savePetition()" :disabled="isSaving">
                    <span x-show="!isSaving">
                        <i class="fas fa-save me-1"></i> Salvar
                    </span>
                    <span x-show="isSaving">
                        <i class="fas fa-spinner fa-spin me-1"></i> Salvando...
                    </span>
                </button>
                
                <!-- Botão Preview -->
                <button type="button" class="btn btn-outline-primary" @click="previewPetition()">
                    <i class="fas fa-eye me-1"></i> Pré-visualizar
                </button>
                
                <!-- Botão Gerar PDF -->
                <button type="submit" class="btn btn-primary" :disabled="isGenerating">
                    <span x-show="!isGenerating">
                        <i class="fas fa-file-pdf me-1"></i> Gerar PDF
                    </span>
                    <span x-show="isGenerating">
                        <i class="fas fa-spinner fa-spin me-1"></i> Gerando...
                    </span>
                </button>
            </div>
        </div>
        
        <!-- Indicador de edição -->
        <template x-if="petitionId">
            <div class="alert alert-info mb-4">
                <i class="fas fa-edit me-2"></i>
                Editando petição salva #<span x-text="petitionId"></span>
                <a :href="'/petitions/saved/' + petitionId" class="ms-2">Ver detalhes</a>
            </div>
        </template>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Preview -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pré-visualização da Petição</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content" class="p-4 bg-white" style="font-family: 'Times New Roman', serif;">
                    <!-- Conteúdo será inserido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" @click="bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide(); $nextTick(() => document.getElementById('petition-form').requestSubmit())">
                    <i class="fas fa-file-pdf me-1"></i> Gerar PDF
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Quill Editor (já no base, mas garantir CSS) -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">

<!-- Módulo de IA -->
<script src="{{ url_for('static', filename='js/petitio-ai.js') }}"></script>

<script>
// Registrar componente Alpine ANTES da inicialização
document.addEventListener('alpine:init', () => {
    Alpine.data('dynamicPetitionForm', () => ({
        sections: window.PETITION_SECTIONS || [],
        formData: {},
        selectedFiles: {},  // Arquivos selecionados por campo
        sectionExpanded: {},
        autoSaveStatus: 'idle',
        isGenerating: false,
        isSaving: false,
        isUploading: false,
        isDragging: false,
        dragover: false,
        cepLoading: null,  // Campo CEP que está carregando
        petitionId: null,  // ID da petição se estiver editando
        attachments: [],  // Lista de anexos da petição
        quillEditors: {},
        autoSaveTimeout: null,
        aiCredits: 10, // Créditos de IA disponíveis
        lockedFields: window.LOCKED_FIELDS || [], // Campos bloqueados para edição
        isPaidPetition: false, // Se a petição já foi paga
        
        init() {
            // Inicializar estado de expansão das seções
            if (this.sections && this.sections.length > 0) {
                this.sections.forEach(s => {
                    this.sectionExpanded[s.section.slug] = s.is_expanded !== false;

                    // A IA agora é controlada pelo campo ai_enabled no schema
                    // Não habilitamos mais automaticamente para todos os campos textarea
                });
            }
            
            // Inicializar seção de anexos
            this.sectionExpanded.attachments = true;
            
            // Verificar se está editando uma petição existente
            if (window.EDIT_PETITION) {
                this.petitionId = window.EDIT_PETITION.id;
                this.formData = window.EDIT_PETITION.form_data || {};
                this.isPaidPetition = window.EDIT_PETITION.is_paid || false;
                this.lockedFields = window.EDIT_PETITION.locked_fields || [];
                
                // Carregar anexos existentes
                this.loadAttachments();
                
                // Restaurar conteúdo dos editores após inicialização
                this.$nextTick(() => {
                    Object.keys(this.quillEditors).forEach(fieldName => {
                        if (this.formData[fieldName]) {
                            this.quillEditors[fieldName].root.innerHTML = this.formData[fieldName];
                        }
                    });
                    
                    // Aplicar bloqueio visual nos campos bloqueados
                    this.applyFieldLocks();
                });
            } else {
                // Carregar rascunho local se existir
                this.loadDraft();
            }
            
            // Inicializar editores Quill e toolbars de IA após DOM estar pronto
            this.$nextTick(() => {
                this.applyMasks();
                this.initAIToolbars();
            });
            
            // Auto-save a cada 30 segundos quando há mudanças
            this.$watch('formData', () => {
                this.scheduleAutoSave();
            }, { deep: true });
        },
        
        // Verifica se um campo está bloqueado para edição
        isFieldLocked(fieldName) {
            return this.lockedFields.includes(fieldName);
        },
        
        // Aplica bloqueio visual nos campos bloqueados
        applyFieldLocks() {
            if (!this.isPaidPetition || this.lockedFields.length === 0) return;
            
            this.lockedFields.forEach(fieldName => {
                const input = document.querySelector(`[name="${fieldName}"]`);
                if (input) {
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('disabled', 'disabled');
                    input.classList.add('bg-light', 'text-muted');
                    input.title = 'Este campo não pode ser alterado após o pagamento';
                    
                    // Adicionar ícone de cadeado
                    const label = input.closest('.mb-3, .form-group')?.querySelector('label');
                    if (label && !label.querySelector('.fa-lock')) {
                        label.innerHTML = `<i class="fas fa-lock text-warning me-1" title="Campo bloqueado"></i>${label.innerHTML}`;
                    }
                }
            });
        },
        
        initAllQuillEditors() {
            // Encontrar todos os campos do tipo editor e inicializá-los
            this.sections.forEach(s => {
                if (s.section.fields_schema) {
                    s.section.fields_schema.forEach(field => {
                        if (field.type === 'editor') {
                            this.$nextTick(() => {
                                this.initQuillEditor(s.section.slug + '_' + field.name);
                            });
                        }
                    });
                }
            });
        },
        
        applyMasks() {
            $('.cpf-mask').mask('000.000.000-00');
            $('.cnpj-mask').mask('00.000.000/0000-00');
            $('.phone-mask').mask('(00) 00000-0000');
            $('.cep-mask').mask('00000-000');
            $('.money-mask').mask('#.##0,00', {reverse: true});
            $('.processo-mask').mask('0000000-00.0000.0.00.0000');
            // CPF/CNPJ usa máscara dinâmica no formatCpfCnpj()
        },
        
        // Status de validação CPF/CNPJ
        cpfCnpjStatus: {},
        
        // Formatar CPF ou CNPJ dinamicamente
        formatCpfCnpj(event) {
            let value = event.target.value.replace(/\D/g, '');
            
            if (value.length <= 11) {
                // Formato CPF: 000.000.000-00
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                // Formato CNPJ: 00.000.000/0000-00
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            
            event.target.value = value;
            // Atualizar o model do Alpine
            const fieldName = event.target.name;
            this.formData[fieldName] = value;
        },
        
        // Validar CPF
        validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11) return false;
            
            // Verifica se todos os dígitos são iguais
            if (/^(\d)\1+$/.test(cpf)) return false;
            
            // Validação dos dígitos verificadores
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;
            
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(10))) return false;
            
            return true;
        },
        
        // Validar CNPJ
        validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14) return false;
            
            // Verifica se todos os dígitos são iguais
            if (/^(\d)\1+$/.test(cnpj)) return false;
            
            // Validação do primeiro dígito verificador
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado !== parseInt(digitos.charAt(0))) return false;
            
            // Validação do segundo dígito verificador
            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado !== parseInt(digitos.charAt(1))) return false;
            
            return true;
        },
        
        // Validar CPF ou CNPJ
        validateCpfCnpj(fieldName) {
            const value = this.formData[fieldName];
            if (!value) {
                this.cpfCnpjStatus[fieldName] = null;
                this.updateLinkedSectionVisibility(fieldName, null);
                return;
            }
            
            const numbers = value.replace(/\D/g, '');
            
            if (numbers.length === 11) {
                this.cpfCnpjStatus[fieldName] = this.validarCPF(numbers) ? 'valid' : 'invalid';
                this.updateLinkedSectionVisibility(fieldName, 'cpf');
            } else if (numbers.length === 14) {
                this.cpfCnpjStatus[fieldName] = this.validarCNPJ(numbers) ? 'valid' : 'invalid';
                this.updateLinkedSectionVisibility(fieldName, 'cnpj');
            } else if (numbers.length > 0) {
                this.cpfCnpjStatus[fieldName] = 'invalid';
                this.updateLinkedSectionVisibility(fieldName, null);
            } else {
                this.cpfCnpjStatus[fieldName] = null;
                this.updateLinkedSectionVisibility(fieldName, null);
            }
        },
        
        // Controlar visibilidade de seções vinculadas (representante legal para CNPJ)
        linkedSectionTriggers: {},  // fieldName -> 'cpf' | 'cnpj' | null
        
        updateLinkedSectionVisibility(fieldName, documentType) {
            this.linkedSectionTriggers[fieldName] = documentType;
            
            // Encontrar o campo que disparou a atualização
            this.sections.forEach(s => {
                const fields = s.section.fields_schema || [];
                fields.forEach(field => {
                    const fullFieldName = s.section.slug + '_' + field.name;
                    if (fullFieldName === fieldName && field.linked_section_id) {
                        // Encontrar a seção vinculada
                        const linkedSection = this.sections.find(
                            ls => ls.section.id === field.linked_section_id
                        );
                        
                        if (linkedSection) {
                            // Mostrar/expandir seção se for CNPJ
                            const trigger = field.linked_section_trigger || 'cnpj';
                            const shouldShow = documentType === trigger;
                            
                            if (shouldShow) {
                                this.sectionExpanded[linkedSection.section.slug] = true;
                            }
                        }
                    }
                });
            });
        },
        
        // Verificar se algum campo cpf_cnpj tem CNPJ (para seções vinculadas)
        hasAnyCnpj() {
            for (const [fieldName, trigger] of Object.entries(this.linkedSectionTriggers)) {
                if (trigger === 'cnpj') return true;
            }
            return false;
        },
        
        toggleSection(slug) {
            this.sectionExpanded[slug] = !this.sectionExpanded[slug];
        },
        
        expandAllSections() {
            this.sections.forEach(s => {
                this.sectionExpanded[s.section.slug] = true;
            });
            this.sectionExpanded.attachments = true;
        },
        
        collapseAllSections() {
            this.sections.forEach(s => {
                this.sectionExpanded[s.section.slug] = false;
            });
            this.sectionExpanded.attachments = false;
        },
        
        getMissingRequiredCount(sectionSlug) {
            // Encontrar a seção
            const sectionConfig = this.sections.find(s => s.section.slug === sectionSlug);
            if (!sectionConfig || !sectionConfig.section.fields_schema) return 0;
            
            // Contar campos obrigatórios não preenchidos
            let count = 0;
            sectionConfig.section.fields_schema.forEach(field => {
                if (field.required) {
                    const value = this.formData[field.name];
                    if (!value || (typeof value === 'string' && value.trim() === '')) {
                        count++;
                    }
                }
            });
            return count;
        },
        
        getTotalMissingRequired() {
            let total = 0;
            this.sections.forEach(s => {
                total += this.getMissingRequiredCount(s.section.slug);
            });
            return total;
        },
        
        shouldShowSection(slug) {
            // Encontrar a seção pelo slug
            const section = this.sections.find(s => s.section.slug === slug);
            
            if (!section) return true;
            
            // Se é uma seção vinculada (representante legal)
            if (section.is_linked_section) {
                // Verificar se algum campo cpf_cnpj está com CNPJ
                for (const s of this.sections) {
                    for (const field of (s.section.fields_schema || [])) {
                        if (field.linked_section_id === section.section.id) {
                            const fieldName = s.section.slug + '_' + field.name;
                            const trigger = field.linked_section_trigger || 'cnpj';
                            
                            // Mostrar se o documento corresponde ao trigger
                            if (this.linkedSectionTriggers[fieldName] === trigger) {
                                return true;
                            }
                        }
                    }
                }
                // Esconder se nenhum campo cpf_cnpj tem CNPJ
                return false;
            }
            
            // Por padrão, mostrar todas as seções
            return true;
        },
        
        shouldShowField(fieldName, showIf) {
            if (!showIf) return true;
            
            // Parse da condição: "campo=valor" ou "campo!=valor"
            const match = showIf.match(/^(\w+)(=|!=)(.+)$/);
            if (!match) return true;
            
            const [, field, operator, value] = match;
            const currentValue = this.formData[field] || '';
            
            if (operator === '=') {
                return currentValue === value;
            } else if (operator === '!=') {
                return currentValue !== value;
            }
            return true;
        },
        
        initQuillEditor(fieldName) {
            // Tentar encontrar o container por ID ou por ref
            let container = document.getElementById('quill_' + fieldName);
            if (!container) {
                container = this.$refs['editor_' + fieldName];
            }

            if (!container) {
                return;
            }

            // Verificar se já foi inicializado
            if (this.quillEditors[fieldName]) {
                return;
            }

            // Criar toolbar de IA antes do editor
            this.createAIToolbarForField(fieldName, container);

            const quill = new Quill(container, {
                theme: 'snow',
                placeholder: 'Digite o conteúdo aqui...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                }
            });

            quill.on('text-change', () => {
                this.formData[fieldName] = quill.root.innerHTML;
            });

            this.quillEditors[fieldName] = quill;

            // Restaurar conteúdo se existir
            if (this.formData[fieldName]) {
                quill.root.innerHTML = this.formData[fieldName];
            }
        },

        initAIToolbars() {
            // Procurar todos os campos que têm IA habilitada
            this.sections.forEach(section => {
                if (section.section.fields_schema) {
                    section.section.fields_schema.forEach(field => {
                        if (field.ai_enabled && (field.type === 'editor' || field.type === 'textarea')) {
                            const fieldName = section.section.slug + '_' + field.name;
                            const sectionSlug = section.section.slug;
                            const element = document.querySelector(`[name="${fieldName}"]`) ||
                                          document.getElementById('quill_' + fieldName);

                            if (element) {
                                if (field.type === 'editor') {
                                    const container = element;
                                    this.createAIToolbarForField(fieldName, container, 'editor', sectionSlug);
                                } else if (field.type === 'textarea') {
                                    this.createAIToolbarForField(fieldName, element, 'textarea', sectionSlug);
                                }
                            }
                        }
                    });
                }
            });
        },

        createAIToolbarForField(fieldName, container, fieldType = 'editor', sectionSlug = '') {
            // Verificar se já existe uma toolbar
            let element = container;
            let toolbarContainer = null;
            
            if (fieldType === 'editor') {
                const wrapper = container.closest('.quill-wrapper');
                if (wrapper) {
                    // Verificar se a toolbar já existe
                    if (wrapper.previousElementSibling && wrapper.previousElementSibling.classList.contains('ai-toolbar')) {
                        return; // Já existe
                    }
                    toolbarContainer = wrapper;
                }
            } else if (fieldType === 'textarea') {
                // Para textarea, verificar se toolbar já existe antes
                if (container.previousElementSibling && container.previousElementSibling.classList.contains('ai-toolbar')) {
                    return; // Já existe
                }
                toolbarContainer = container;
            }

            if (!toolbarContainer) return; // Nenhum container válido

            // Determinar tipo de seção para mostrar botões apropriados
            const slug = sectionSlug.toLowerCase().replace(/_/g, '-');
            const isFatosSection = ['fatos', 'dos-fatos', 'narrativa', 'historico'].some(s => slug.includes(s));
            const isFundamentosSection = ['direito', 'fundamentos', 'fundamentacao', 'juridic'].some(s => slug.includes(s));

            // Criar toolbar de IA
            const toolbar = document.createElement('div');
            toolbar.className = 'ai-toolbar d-flex justify-content-between align-items-center';

            let toolbarHTML = '';
            
            if (isFatosSection) {
                // Fatos: NÃO pode gerar do zero, apenas formalizar/melhorar
                toolbarHTML = `
                    <div class="d-flex gap-2 align-items-center">
                        <span class="text-muted small">
                            <i class="fas fa-info-circle text-info me-1"></i>
                            Escreva os fatos e a IA formaliza:
                        </span>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="window.PetitionForm?.improveContent('${fieldName}')">
                            <i class="fas fa-gavel me-1"></i> Formalizar Texto
                            <span class="badge bg-secondary ms-1">1 crédito</span>
                        </button>
                    </div>
                `;
            } else if (isFundamentosSection) {
                // Fundamentação: pode gerar baseado nos fatos
                toolbarHTML = `
                    <div class="d-flex gap-2 align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-success"
                                onclick="window.PetitionForm?.generateAIContent('${fieldName}')"
                                data-tour="petition-ai-button">
                            <i class="fas fa-magic me-1"></i> Gerar Fundamentação
                            <span class="badge bg-success bg-opacity-25 text-success ms-1">3 créditos</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="window.PetitionForm?.improveContent('${fieldName}')">
                            <i class="fas fa-edit me-1"></i> Melhorar
                            <span class="badge bg-secondary ms-1">1 crédito</span>
                        </button>
                    </div>
                `;
            } else {
                // Outras seções: botões padrão
                toolbarHTML = `
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-success"
                                onclick="window.PetitionForm?.generateAIContent('${fieldName}')"
                                data-tour="petition-ai-button">
                            <i class="fas fa-magic me-1"></i> Gerar com IA
                            <span class="badge bg-success bg-opacity-25 text-success ms-1">1 crédito</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="window.PetitionForm?.improveContent('${fieldName}')">
                            <i class="fas fa-edit me-1"></i> Melhorar
                            <span class="badge bg-secondary ms-1">1 crédito</span>
                        </button>
                    </div>
                `;
            }

            toolbar.innerHTML = toolbarHTML;

            // Inserir antes do elemento
            if (toolbarContainer) {
                toolbarContainer.parentNode.insertBefore(toolbar, toolbarContainer);
            }
        },

        async buscarCEP(fieldName) {
            const cep = (this.formData[fieldName] || '').replace(/\D/g, '');
            if (cep.length !== 8) return;
            
            // Mostrar indicador de carregamento
            this.cepLoading = fieldName;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (!data.erro) {
                    // Extrair prefixo da seção do campo CEP (ex: autor_cep -> autor_, reu_cep -> reu_)
                    const sectionPrefix = fieldName.replace(/_cep$/i, '_');
                    
                    // Mapeamento de campos do ViaCEP para possíveis nomes de campos
                    const fieldMappings = {
                        logradouro: ['endereco', 'rua', 'logradouro', 'address', 'street'],
                        bairro: ['bairro', 'neighborhood', 'district'],
                        localidade: ['cidade', 'city', 'municipio', 'localidade'],
                        uf: ['estado', 'uf', 'state']
                    };
                    
                    // Tentar preencher cada campo
                    for (const [viaCepField, possibleNames] of Object.entries(fieldMappings)) {
                        if (!data[viaCepField]) continue;
                        
                        // Tentar encontrar o campo com o prefixo da seção
                        for (const name of possibleNames) {
                            const fieldNameWithSection = sectionPrefix + name;
                            
                            // Verificar se o campo existe no formData
                            if (this.fieldExists(fieldNameWithSection)) {
                                this.formData[fieldNameWithSection] = data[viaCepField];
                                break;
                            }
                        }
                    }
                    
                    this.showToast('Endereço preenchido automaticamente!', 'success');
                } else {
                    this.showToast('CEP não encontrado.', 'warning');
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                this.showToast('Erro ao buscar CEP. Verifique sua conexão.', 'error');
            } finally {
                this.cepLoading = null;
            }
        },
        
        fieldExists(fieldName) {
            // Extrair o nome do campo e o prefixo da seção
            const parts = fieldName.split('_');
            if (parts.length < 2) return false;
            
            const sectionSlug = parts[0];
            const actualFieldName = parts.slice(1).join('_');
            
            // Verificar se o campo existe nas seções configuradas
            for (const section of this.sections) {
                if (section.section.slug === sectionSlug && section.section.fields_schema) {
                    for (const field of section.section.fields_schema) {
                        if (field.name === actualFieldName) {
                            return true;
                        }
                    }
                }
            }
            return false;
        },
        
        scheduleAutoSave() {
            if (this.autoSaveTimeout) {
                clearTimeout(this.autoSaveTimeout);
            }
            this.autoSaveTimeout = setTimeout(() => {
                this.saveAsDraft();
            }, 30000); // 30 segundos
        },
        
        async saveAsDraft() {
            this.autoSaveStatus = 'saving';
            
            try {
                const key = 'petition_draft_' + window.PETITION_TYPE.slug;
                localStorage.setItem(key, JSON.stringify({
                    formData: this.formData,
                    timestamp: new Date().toISOString()
                }));
                
                this.autoSaveStatus = 'saved';
                setTimeout(() => {
                    this.autoSaveStatus = 'idle';
                }, 2000);
            } catch (error) {
                this.autoSaveStatus = 'error';
                console.error('Erro ao salvar rascunho:', error);
            }
        },
        
        loadDraft() {
            try {
                const key = 'petition_draft_' + window.PETITION_TYPE.slug;
                const saved = localStorage.getItem(key);
                if (saved) {
                    const data = JSON.parse(saved);
                    this.formData = data.formData || {};
                    
                    // Restaurar conteúdo dos editores Quill
                    this.$nextTick(() => {
                        Object.keys(this.quillEditors).forEach(fieldName => {
                            if (this.formData[fieldName]) {
                                this.quillEditors[fieldName].root.innerHTML = this.formData[fieldName];
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar rascunho:', error);
            }
        },
        
        async clearForm() {
            const confirmed = await showConfirmModal({
                title: 'Limpar Formulário',
                message: 'Tem certeza que deseja limpar todo o formulário?<br><br><small class="text-muted">Todos os dados preenchidos serão perdidos.</small>',
                type: 'warning',
                confirmText: 'Limpar'
            });
            if (!confirmed) return;
            
            this.formData = {};
            this.petitionId = null;
            Object.keys(this.quillEditors).forEach(fieldName => {
                this.quillEditors[fieldName].root.innerHTML = '';
            });
            
            const key = 'petition_draft_' + window.PETITION_TYPE.slug;
            localStorage.removeItem(key);
        },
        
        async savePetition() {
            this.isSaving = true;
            
            try {
                const response = await fetch('/petitions/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        petition_id: this.petitionId,
                        petition_type_id: window.PETITION_TYPE.id,
                        form_data: this.formData,
                        action: 'save'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.petitionId = data.petition_id;
                    
                    // Limpar rascunho local após salvar no servidor
                    const key = 'petition_draft_' + window.PETITION_TYPE.slug;
                    localStorage.removeItem(key);
                    
                    // Mostrar toast de sucesso
                    this.showToast('Petição salva com sucesso!', 'success');
                    
                    // Atualizar URL para modo edição
                    const newUrl = `/petitions/dynamic/${window.PETITION_TYPE.slug}?edit_id=${data.petition_id}`;
                    window.history.replaceState({}, '', newUrl);
                } else {
                    this.showToast(data.error || 'Erro ao salvar petição', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                this.showToast('Erro ao salvar petição. Tente novamente.', 'error');
            } finally {
                this.isSaving = false;
            }
        },
        
        showToast(message, type = 'info') {
            // Criar toast simples
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        },
        
        // ============ MÉTODOS DE ANEXOS ============
        
        async loadAttachments() {
            if (!this.petitionId) return;
            
            try {
                const response = await fetch(`/petitions/api/saved/${this.petitionId}/attachments`);
                const data = await response.json();
                
                if (data.success) {
                    this.attachments = data.attachments;
                }
            } catch (error) {
                console.error('Erro ao carregar anexos:', error);
            }
        },
        
        handleDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.uploadFiles(files);
            }
        },
        
        async uploadFiles(files) {
            if (!this.petitionId) {
                this.showToast('Salve a petição antes de anexar arquivos.', 'warning');
                return;
            }
            
            this.isUploading = true;
            
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['application/pdf', 'application/msword', 
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg', 'image/png', 'image/gif'];
            
            for (const file of files) {
                // Validar tamanho
                if (file.size > maxSize) {
                    this.showToast(`Arquivo ${file.name} excede o tamanho máximo de 10MB.`, 'error');
                    continue;
                }
                
                // Validar tipo
                if (!allowedTypes.includes(file.type)) {
                    this.showToast(`Tipo de arquivo não permitido: ${file.name}`, 'error');
                    continue;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch(`/petitions/api/saved/${this.petitionId}/attachments`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showToast(`Arquivo ${file.name} enviado com sucesso!`, 'success');
                        this.loadAttachments();
                    } else {
                        this.showToast(data.error || 'Erro ao enviar arquivo', 'error');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    this.showToast(`Erro ao enviar ${file.name}`, 'error');
                }
            }
            
            this.isUploading = false;
        },
        
        async deleteAttachment(attachmentId) {
            const confirmed = await confirmDelete('este arquivo');
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/petitions/api/attachments/${attachmentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showToast('Arquivo removido com sucesso!', 'success');
                    this.loadAttachments();
                } else {
                    this.showToast(data.error || 'Erro ao remover arquivo', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                this.showToast('Erro ao remover arquivo', 'error');
            }
        },
        
        // ============ FIM DOS MÉTODOS DE ANEXOS ============
        
        formatFieldLabel(fieldName) {
            // Buscar o label do campo nas seções
            for (const section of this.sections) {
                if (section.section.fields_schema) {
                    for (const field of section.section.fields_schema) {
                        if (field.name === fieldName) {
                            return field.label;
                        }
                    }
                }
            }
            // Se não encontrar, formatar o nome do campo
            return fieldName
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        },
        
        previewPetition() {
            // Gerar preview da petição
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const content = document.getElementById('preview-content');
            
            // Montar HTML de preview baseado nos dados organizados por seção
            let html = '<div class="text-center mb-4">';
            html += '<h4>EXCELENTÍSSIMO SENHOR DOUTOR JUIZ DE DIREITO</h4>';
            html += '</div>';
            
            // Organizar por seções
            this.sections.forEach(sectionConfig => {
                const section = sectionConfig.section;
                const fields = section.fields_schema || [];
                
                // Verificar se há dados preenchidos nesta seção
                const sectionHasData = fields.some(field => {
                    const value = this.formData[field.name];
                    return value && value.toString().trim() !== '';
                });
                
                if (sectionHasData) {
                    html += `<div class="preview-section mb-4">`;
                    html += `<h5 class="border-bottom pb-2 mb-3"><i class="fas ${section.icon || 'fa-file-alt'} me-2 text-${section.color || 'primary'}"></i>${section.name}</h5>`;
                    html += `<div class="row">`;
                    
                    fields.forEach(field => {
                        const value = this.formData[field.name];
                        if (value && value.toString().trim() !== '') {
                            // Definir largura baseado no tipo
                            const colSize = ['editor', 'textarea'].includes(field.type) ? '12' : '6';
                            
                            html += `<div class="col-md-${colSize} mb-2">`;
                            html += `<strong class="text-muted small">${field.label}:</strong><br>`;
                            
                            // Formatar valor baseado no tipo
                            if (field.type === 'editor') {
                                html += `<div class="border rounded p-2 bg-light">${value}</div>`;
                            } else if (field.type === 'checkbox') {
                                html += value ? 'Sim' : 'Não';
                            } else {
                                html += `<span>${value}</span>`;
                            }
                            
                            html += `</div>`;
                        }
                    });
                    
                    html += `</div></div>`;
                }
            });
            
            // Campos não mapeados (se houver)
            const mappedFields = new Set();
            this.sections.forEach(s => {
                (s.section.fields_schema || []).forEach(f => mappedFields.add(f.name));
            });
            
            const unmappedData = Object.entries(this.formData).filter(([key, value]) => 
                !mappedFields.has(key) && value && value.toString().trim() !== ''
            );
            
            if (unmappedData.length > 0) {
                html += `<div class="preview-section mb-4">`;
                html += `<h5 class="border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2 text-secondary"></i>Outros Dados</h5>`;
                html += `<div class="row">`;
                unmappedData.forEach(([key, value]) => {
                    html += `<div class="col-md-6 mb-2">`;
                    html += `<strong class="text-muted small">${this.formatFieldLabel(key)}:</strong><br>`;
                    html += `<span>${value}</span>`;
                    html += `</div>`;
                });
                html += `</div></div>`;
            }
            
            content.innerHTML = html;
            modal.show();
        },
        
        async generateAIContent(fieldName) {
            console.log('generateAIContent called for field:', fieldName);
            console.log('PetitioAI available:', typeof PetitioAI);

            if (typeof PetitioAI === 'undefined') {
                console.error('PetitioAI is undefined');
                this.showToast('Sistema de IA não disponível', 'error');
                return;
            }

            const ai = PetitioAI;
            console.log('AI object:', ai);

            // Encontrar o campo na estrutura de seções
            let field = null;
            let sectionName = '';
            for (const section of this.sections) {
                if (section.section.fields_schema) {
                    field = section.section.fields_schema.find(f => section.section.slug + '_' + f.name === fieldName);
                    if (field) {
                        sectionName = section.section.name;
                        break;
                    }
                }
            }

            console.log('Field found:', field);

            if (!field) {
                console.error('Field not found for name:', fieldName);
                this.showToast('Campo não encontrado', 'error');
                return;
            }

            // Verificar créditos
            console.log('User credits:', ai.userCredits, 'Unlimited:', ai.isUnlimited);
            if (!ai.isUnlimited && ai.userCredits < ai.creditCosts.section) {
                console.log('Insufficient credits');
                this.showToast('Créditos insuficientes para gerar conteúdo', 'warning');
                return;
            }

            const existingContent = this.formData[fieldName] || '';
            console.log('Existing content length:', existingContent.length);

            // Confirmação se já tem conteúdo
            if (existingContent && existingContent.length > 50) {
                const confirmed = await showConfirmModal({
                    title: 'Substituir Conteúdo',
                    message: 'Este campo já tem conteúdo. Deseja substituir pelo conteúdo gerado pela IA?',
                    type: 'info',
                    confirmText: 'Substituir'
                });
                if (!confirmed) return;
            }

            try {
                // Mostrar loading
                console.log('Starting AI generation...');
                this.showToast('Gerando conteúdo com IA...', 'info');

                // Coletar contexto completo do formulário para a IA
                const context = {
                    petition_type: window.PETITION_TYPE?.slug || 'petition',
                    petition_type_name: window.PETITION_TYPE?.name || 'Petição',
                    section_type: sectionName || 'general'
                };

                // Coletar dados de todas as seções preenchidas
                this.sections.forEach(section => {
                    const slug = section.section.slug;
                    const sectionData = {};
                    
                    if (section.section.fields_schema) {
                        section.section.fields_schema.forEach(field => {
                            const key = slug + '_' + field.name;
                            const value = this.formData[key];
                            if (value && value.toString().trim()) {
                                // Limpar HTML se for editor
                                let cleanValue = value;
                                if (field.type === 'editor') {
                                    cleanValue = value.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                                }
                                sectionData[field.name] = cleanValue;
                            }
                        });
                    }
                    
                    // Identificar e adicionar ao contexto
                    const slugLower = slug.toLowerCase();
                    if (slugLower.includes('autor') || slugLower.includes('requerente')) {
                        context.autor = sectionData;
                    } else if (slugLower.includes('reu') || slugLower.includes('requerido')) {
                        context.reu = sectionData;
                    } else if (slugLower.includes('fatos') || slugLower.includes('narrativa')) {
                        context.fatos_resumo = Object.values(sectionData).join(' ');
                    } else if (slugLower.includes('pedidos')) {
                        context.pedidos_resumo = Object.values(sectionData).join(' ');
                    }
                });

                console.log('Context:', context);

                // Fazer requisição para gerar conteúdo
                console.log('Making API request to /ai/api/generate/section');
                const response = await fetch('/ai/api/generate/section', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        section_type: sectionName || 'general',
                        petition_type: window.PETITION_TYPE?.slug || 'petition',
                        context: context,
                        existing_content: existingContent,
                        premium: false
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    // Inserir conteúdo no campo
                    if (field.type === 'editor' && this.quillEditors[fieldName]) {
                        this.quillEditors[fieldName].root.innerHTML = data.content;
                    }
                    this.formData[fieldName] = data.content;

                    // Atualizar créditos se necessário
                    if (data.credits_remaining !== '∞') {
                        this.aiCredits = data.credits_remaining;
                    }

                    this.showToast('Conteúdo gerado com sucesso!', 'success');
                } else {
                    if (response.status === 402) {
                        this.showToast('Créditos insuficientes', 'warning');
                    } else {
                        this.showToast(data.error || 'Erro ao gerar conteúdo', 'error');
                    }
                }
            } catch (error) {
                console.error('Erro ao gerar conteúdo com IA:', error);
                this.showToast('Erro ao gerar conteúdo com IA', 'error');
            }
        },

        async improveContent(fieldName) {
            console.log('improveContent called for field:', fieldName);
            console.log('PetitioAI available:', typeof PetitioAI);

            if (typeof PetitioAI === 'undefined') {
                console.error('PetitioAI is undefined');
                this.showToast('Sistema de IA não disponível', 'error');
                return;
            }

            const ai = PetitioAI;
            const currentContent = this.formData[fieldName] || '';
            console.log('Current content length:', currentContent.length);

            if (!currentContent.trim()) {
                console.log('Content is empty');
                this.showToast('Campo vazio. Digite algum conteúdo primeiro.', 'warning');
                return;
            }

            // Verificar créditos
            console.log('User credits:', ai.userCredits, 'Unlimited:', ai.isUnlimited);
            if (!ai.isUnlimited && ai.userCredits < ai.creditCosts.improve) {
                console.log('Insufficient credits for improvement');
                this.showToast('Créditos insuficientes para melhorar conteúdo', 'warning');
                return;
            }

            try {
                // Mostrar loading
                console.log('Starting content improvement...');
                this.showToast('Melhorando conteúdo com IA...', 'info');

                // Encontrar o campo na estrutura de seções
                let sectionName = '';
                for (const section of this.sections) {
                    if (section.section.fields_schema) {
                        const field = section.section.fields_schema.find(f => section.section.slug + '_' + f.name === fieldName);
                        if (field) {
                            sectionName = section.section.name;
                            break;
                        }
                    }
                }

                // Preparar contexto
                const context = {
                    petition_type: window.PETITION_TYPE?.slug || 'petition',
                    section_type: sectionName || 'general'
                };
                console.log('Context:', context);

                // Fazer requisição para melhorar conteúdo
                console.log('Making API request to /ai/api/generate/improve');
                const response = await fetch('/ai/api/generate/improve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: currentContent,
                        context: JSON.stringify(context),
                        premium: false
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    // Atualizar conteúdo no campo
                    if (this.quillEditors[fieldName]) {
                        this.quillEditors[fieldName].root.innerHTML = data.content;
                    }
                    this.formData[fieldName] = data.content;

                    // Atualizar créditos se necessário
                    if (data.credits_remaining !== '∞') {
                        this.aiCredits = data.credits_remaining;
                    }

                    this.showToast('Conteúdo melhorado com sucesso!', 'success');
                } else {
                    if (response.status === 402) {
                        this.showToast('Créditos insuficientes', 'warning');
                    } else {
                        this.showToast(data.error || 'Erro ao melhorar conteúdo', 'error');
                    }
                }
            } catch (error) {
                console.error('Erro ao melhorar conteúdo com IA:', error);
                this.showToast('Erro ao melhorar conteúdo com IA', 'error');
            }
        },
        
        handleFileSelect(event, fieldName) {
            const files = Array.from(event.target.files);
            this.processFiles(files, fieldName);
        },
        
        handleFileDrop(event, fieldName) {
            this.dragover = false;
            const files = Array.from(event.dataTransfer.files);
            this.processFiles(files, fieldName);
        },
        
        processFiles(files, fieldName) {
            if (!this.selectedFiles[fieldName]) {
                this.selectedFiles[fieldName] = [];
            }
            
            // Limite total de 50MB para todos os arquivos do campo
            const maxTotalSize = 50 * 1024 * 1024; // 50MB total
            const maxIndividualSize = 20 * 1024 * 1024; // 20MB por arquivo individual
            const allowedTypes = ['application/pdf', 'application/msword', 
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg', 'image/png', 'image/gif', 'text/plain'];
            
            // Calcular tamanho total atual
            let currentTotalSize = (this.selectedFiles[fieldName] || []).reduce((sum, f) => sum + f.size, 0);
            
            for (const file of files) {
                // Validar tamanho individual
                if (file.size > maxIndividualSize) {
                    this.showToast(`Arquivo ${file.name} excede o tamanho máximo de 20MB.`, 'error');
                    continue;
                }
                
                // Validar tamanho total
                if (currentTotalSize + file.size > maxTotalSize) {
                    this.showToast(`Total de arquivos excede o limite de 50MB. Remova alguns arquivos e tente novamente.`, 'error');
                    break;
                }
                
                // Validar tipo
                if (!allowedTypes.includes(file.type)) {
                    this.showToast(`Tipo de arquivo não permitido: ${file.name}`, 'error');
                    continue;
                }
                
                // Adicionar à lista
                this.selectedFiles[fieldName].push(file);
                currentTotalSize += file.size;
            }
            
            // Armazenar referência nos formData
            this.formData[fieldName] = (this.selectedFiles[fieldName] || []).map(f => f.name).join(', ');
        },
        
        removeFile(fieldName, index) {
            if (this.selectedFiles[fieldName]) {
                this.selectedFiles[fieldName].splice(index, 1);
                this.formData[fieldName] = (this.selectedFiles[fieldName] || []).map(f => f.name).join(', ');
            }
        },
        
        async generatePetition() {
            this.isGenerating = true;
            
            try {
                const response = await fetch('{{ url_for("petitions.generate_dynamic") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        petition_type_id: window.PETITION_TYPE.id,
                        petition_model_id: {{ petition_model.id }},
                        form_data: this.formData
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = window.PETITION_TYPE.name.replace(/ /g, '_') + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    
                    // Limpar rascunho após gerar com sucesso
                    const key = 'petition_draft_' + window.PETITION_TYPE.slug;
                    localStorage.removeItem(key);
                } else {
                    const error = await response.json();
                    this.showToast('Erro ao gerar petição: ' + (error.error || error.message || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                this.showToast('Erro ao gerar petição. Tente novamente.', 'error');
            } finally {
                this.isGenerating = false;
            }
        }
    }));
    
    // Componente para análise de documentos na fundamentação
    Alpine.data('documentAnalysis', (fieldName) => ({
        fieldName: fieldName,
        documentFile: null,
        documentAnalysisResult: null,
        generatedFundamentos: null,
        isAnalyzing: false,
        analyzeStatus: '',
        error: null,
        isDragging: false,
        showAnalysis: true,
        
        handleDocumentDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.selectDocument(files[0]);
            }
        },
        
        handleDocumentSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                this.selectDocument(files[0]);
            }
        },
        
        selectDocument(file) {
            // Validar tipo
            const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
            const allowedExtensions = ['.pdf', '.docx', '.txt'];
            
            const hasValidExtension = allowedExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            
            if (!hasValidExtension) {
                this.error = 'Formato não suportado. Use PDF, DOCX ou TXT.';
                return;
            }
            
            // Validar tamanho (10MB)
            if (file.size > 10 * 1024 * 1024) {
                this.error = 'Arquivo muito grande. Máximo: 10MB';
                return;
            }
            
            this.documentFile = file;
            this.error = null;
            this.documentAnalysisResult = null;
            this.generatedFundamentos = null;
        },
        
        clearDocument() {
            this.documentFile = null;
            this.documentAnalysisResult = null;
            this.generatedFundamentos = null;
            this.error = null;
        },
        
        async analyzeDocument() {
            if (!this.documentFile) return;
            
            this.isAnalyzing = true;
            this.analyzeStatus = 'Enviando documento...';
            this.error = null;
            
            try {
                // 1. Upload e análise do documento
                const formData = new FormData();
                formData.append('document', this.documentFile);
                
                this.analyzeStatus = 'Analisando documento com IA...';
                
                const analyzeResponse = await fetch('/ai/api/analyze-document', {
                    method: 'POST',
                    body: formData
                });
                
                const analyzeData = await analyzeResponse.json();
                
                if (!analyzeData.success) {
                    throw new Error(analyzeData.error || 'Erro ao analisar documento');
                }
                
                this.documentAnalysisResult = analyzeData.analysis;
                
                // 2. Gerar fundamentação baseada na análise
                this.analyzeStatus = 'Gerando fundamentação jurídica...';
                
                const fundamentosResponse = await fetch('/ai/api/generate-fundamentos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        document_analysis: analyzeData.analysis,
                        petition_type: window.PETITION_TYPE?.name || ''
                    })
                });
                
                const fundamentosData = await fundamentosResponse.json();
                
                if (!fundamentosData.success) {
                    throw new Error(fundamentosData.error || 'Erro ao gerar fundamentação');
                }
                
                this.generatedFundamentos = fundamentosData.fundamentos;
                
                // 3. Inserir no editor Quill
                this.insertIntoEditor(fundamentosData.fundamentos);
                
                // Mostrar sucesso
                if (window.showToast) {
                    window.showToast('Fundamentação gerada com sucesso!', 'success');
                }
                
            } catch (err) {
                console.error('Erro na análise:', err);
                this.error = err.message || 'Erro ao processar documento';
            } finally {
                this.isAnalyzing = false;
                this.analyzeStatus = '';
            }
        },
        
        insertIntoEditor(content) {
            // Buscar o editor Quill do campo
            const editorId = 'quill_' + this.fieldName;
            const editorElement = document.getElementById(editorId);
            
            if (editorElement && editorElement.__quill) {
                const quill = editorElement.__quill;
                
                // Limpar e inserir novo conteúdo
                quill.root.innerHTML = content.replace(/\n/g, '<br>');
                
                // Disparar evento de mudança para o Alpine detectar
                const event = new Event('text-change');
                editorElement.dispatchEvent(event);
                
                // Atualizar formData do Alpine pai
                const parentComponent = Alpine.$data(document.querySelector('[x-data*="dynamicPetitionForm"]'));
                if (parentComponent) {
                    parentComponent.formData[this.fieldName] = content;
                }
            } else {
                // Fallback: tentar encontrar textarea
                const textarea = document.querySelector(`textarea[name="${this.fieldName}"]`);
                if (textarea) {
                    textarea.value = content;
                    textarea.dispatchEvent(new Event('input'));
                }
            }
        }
    }));
});
</script>

<!-- JavaScript para formulários dinâmicos baseados em modelos -->
<script src="{{ url_for('static', filename='js/model_petition_form.js') }}"></script>
{% endblock %}
