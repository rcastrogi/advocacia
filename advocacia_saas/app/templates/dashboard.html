{% extends "base.html" %}

{% block content %}
<!-- Notificações Push Container -->
<div id="notificationsContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999; max-width: 400px;">
    {% for notification in notifications %}
    <div class="toast show notification-toast" role="alert" data-notification-id="{{ notification.id }}" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-warning text-dark">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong class="me-auto">{{ notification.title }}</strong>
            <small class="text-muted">Agora</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            {{ notification.message }}
            {% if notification.link %}
            <div class="mt-2">
                <a href="{{ notification.link }}" class="btn btn-sm btn-warning text-dark">
                    <i class="fas fa-arrow-right me-1"></i>Ver Planos
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Page Header -->
<div class="breadcrumb-custom">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="text-white mb-2">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </h1>
                <p class="text-white opacity-75 mb-0">
                    Bem-vindo, <strong>{{ current_user.full_name or current_user.username }}</strong>!
                    {% if current_user.user_type %}
                        <span class="badge {% if current_user.user_type == 'escritorio' %}badge-escritorio{% else %}badge-advogado{% endif %} ms-2">
                            {{ current_user.user_type|title }}
                        </span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container my-5 content-wrapper">
    <!-- Quick Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Total de Clientes</p>
                        <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700; color: var(--dark-color);">{{ stats.total_clients }}</h2>
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>Ativo
                        </small>
                    </div>
                    <div class="card-icon bg-primary">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <a href="{{ url_for('clients.index') }}" class="text-decoration-none" style="color: var(--primary-color); font-weight: 500;">
                        Ver todos <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Petições IA</p>
                        {% if petition_usage.is_unlimited %}
                        <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700; color: var(--dark-color);">{{ petition_usage.total_used }}</h2>
                        <small class="text-success">
                            <i class="fas fa-infinity me-1"></i>Ilimitadas
                        </small>
                        {% else %}
                        <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700; color: var(--dark-color);">{{ petition_usage.used }}</h2>
                        <small class="{% if petition_usage.is_near_limit %}text-warning{% else %}text-info{% endif %}">
                            <i class="fas fa-chart-line me-1"></i>de {{ petition_usage.limit }}
                        </small>
                        {% endif %}
                    </div>
                    <div class="card-icon {% if petition_usage.is_near_limit %}bg-warning{% else %}bg-info{% endif %}">
                        <i class="fas fa-file-contract"></i>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <a href="#petition-usage-details" class="text-decoration-none" style="color: var(--primary-color); font-weight: 500;">
                        Ver detalhes <i class="fas fa-arrow-down ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Documentos</p>
                        <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700; color: var(--dark-color);">0</h2>
                        <small class="text-warning">
                            <i class="fas fa-file me-1"></i>Pendentes
                        </small>
                    </div>
                    <div class="card-icon bg-warning">
                        <i class="fas fa-file-alt"></i>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <a href="#" class="text-decoration-none" style="color: var(--primary-color); font-weight: 500;">
                        Gerenciar <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Plano Ativo</p>
                        <h2 class="mb-0" style="font-size: 1.5rem; font-weight: 700; color: var(--dark-color);">{{ petition_usage.plan_name }}</h2>
                        <small class="text-secondary">
                            <i class="fas fa-crown me-1"></i>{{ petition_usage.plan_type|title }}
                        </small>
                    </div>
                    <div class="card-icon bg-warning">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <a href="{{ url_for('payments.plans') }}" class="text-decoration-none" style="color: var(--primary-color); font-weight: 500;">
                        Planos <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Petition Usage Details -->
    <div class="row g-4 mb-5" id="petition-usage-details">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0" style="font-weight: 600; color: var(--dark-color);">
                        <i class="fas fa-chart-bar me-2"></i>Uso de Petições IA - {{ petition_usage.plan_name }}
                    </h4>
                    {% if not petition_usage.is_unlimited and petition_usage.is_near_limit %}
                    <span class="badge bg-warning text-dark px-3 py-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>Próximo ao limite
                    </span>
                    {% elif petition_usage.is_unlimited %}
                    <span class="badge bg-success px-3 py-2">
                        <i class="fas fa-infinity me-1"></i>Ilimitadas
                    </span>
                    {% endif %}
                </div>
                
                {% if petition_usage.is_unlimited %}
                <div class="text-center py-5">
                    <i class="fas fa-infinity text-success mb-3" style="font-size: 4rem;"></i>
                    <h3 class="text-success">Petições Ilimitadas</h3>
                    <p class="text-muted mb-4">Você pode gerar quantas petições IA precisar!</p>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="bg-light p-4 rounded">
                                <div class="row text-center">
                                    <div class="col-6 border-end">
                                        <h4 class="mb-1">{{ petition_usage.total_used }}</h4>
                                        <small class="text-muted">Total Geradas</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="mb-1">{{ petition_usage.free_used }}</h4>
                                        <small class="text-muted">Gratuitas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Petições Billable Utilizadas</span>
                        <strong>{{ petition_usage.used }}/{{ petition_usage.limit }}</strong>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar {% if petition_usage.is_over_limit %}bg-danger{% elif petition_usage.is_near_limit %}bg-warning{% else %}bg-primary{% endif %}" 
                             role="progressbar" 
                             style="width: {{ petition_usage.percentage_used }}%;" 
                             aria-valuenow="{{ petition_usage.used }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ petition_usage.limit }}">
                            {{ petition_usage.percentage_used }}%
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">{{ petition_usage.remaining }} petições restantes neste mês</small>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded text-center">
                            <h3 class="mb-1">{{ petition_usage.used }}</h3>
                            <small class="text-muted">Petições Billable</small>
                            <p class="mb-0 mt-2 text-muted" style="font-size: 0.85rem;">Contam para o limite</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded text-center">
                            <h3 class="mb-1">{{ petition_usage.free_used }}</h3>
                            <small class="text-muted">Petições Gratuitas</small>
                            <p class="mb-0 mt-2 text-success" style="font-size: 0.85rem;">Não contam no limite</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded text-center">
                            <h3 class="mb-1">{{ petition_usage.total_used }}</h3>
                            <small class="text-muted">Total Geradas</small>
                            <p class="mb-0 mt-2 text-muted" style="font-size: 0.85rem;">Todas as petições</p>
                        </div>
                    </div>
                </div>
                
                {% if petition_usage.is_near_limit %}
                <div class="alert alert-warning mt-4 d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <strong>Atenção!</strong> Você está próximo do limite de petições.
                        <a href="{{ url_for('payments.plans') }}" class="alert-link">Considere fazer upgrade</a> para continuar sem interrupções.
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="row g-4">
        <!-- Recent Clients -->
        <div class="col-lg-8">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0" style="font-weight: 600; color: var(--dark-color);">
                        <i class="fas fa-users me-2"></i>Clientes Recentes
                    </h4>
                    <a href="{{ url_for('clients.index') }}" class="btn btn-sm btn-outline-primary">
                        Ver Todos
                    </a>
                </div>
                
                {% if stats.recent_clients %}
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Data Cadastro</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in stats.recent_clients %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" 
                                             style="width: 40px; height: 40px; font-weight: 600;">
                                            {{ client.full_name[0]|upper }}
                                        </div>
                                        <div>
                                            <strong>{{ client.full_name }}</strong>
                                            <br><small class="text-muted">{{ client.cpf }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ client.email or '-' }}</td>
                                <td>{{ client.phone or '-' }}</td>
                                <td>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ client.created_at.strftime('%d/%m/%Y') if client.created_at else '-' }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('clients.view', id=client.id) }}" 
                                           class="btn btn-sm btn-outline-primary" title="Visualizar">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('clients.edit', id=client.id) }}" 
                                           class="btn btn-sm btn-outline-secondary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-3">Nenhum cliente cadastrado ainda</p>
                    <a href="{{ url_for('clients.new') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Cadastrar Primeiro Cliente
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions & Info -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="dashboard-card mb-4">
                <h5 class="mb-4" style="font-weight: 600; color: var(--dark-color);">
                    <i class="fas fa-bolt me-2"></i>Ações Rápidas
                </h5>
                <div class="d-grid gap-2">
                    {% if quick_actions %}
                        {% for action in quick_actions %}
                            <a href="{{ action.url }}" class="{{ action.button_class }}{% if action.disabled %} disabled{% endif %}" {% if action.disabled %}aria-disabled="true"{% endif %}>
                                <i class="{{ action.icon }} me-1"></i>{{ action.label }}
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-muted small">
                            Configure suas ações rápidas em <a href="{{ url_for('auth.profile') }}">Meu Perfil</a> para vê-las aqui.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Usage Analytics (History & Predictions) -->
    {% if not petition_usage.is_unlimited %}
    <div class="row g-4 mt-1">
        <!-- Usage History Graph -->
        <div class="col-lg-8">
            <div class="dashboard-card">
                <h5 class="mb-4" style="font-weight: 600; color: var(--dark-color);">
                    <i class="fas fa-chart-line me-2"></i>Histórico de Uso (6 Meses)
                </h5>
                <div id="usageHistoryChart"></div>
            </div>
        </div>
        
        <!-- Predictions & Insights -->
        <div class="col-lg-4">
            <!-- Prediction Card -->
            {% if prediction %}
            <div class="dashboard-card mb-4">
                <h6 class="mb-3" style="font-weight: 600; color: var(--dark-color);">
                    <i class="fas fa-crystal-ball me-2"></i>Previsão de Limite
                </h6>
                {% if prediction.days_remaining and prediction.days_remaining > 0 %}
                <div class="text-center py-3">
                    <h2 class="mb-2 {% if prediction.days_remaining <= 7 %}text-danger{% elif prediction.days_remaining <= 14 %}text-warning{% else %}text-success{% endif %}">
                        {{ prediction.days_remaining }}
                    </h2>
                    <p class="text-muted mb-2">dias até atingir o limite</p>
                    <small class="text-muted d-block">
                        <i class="fas fa-calendar me-1"></i>{{ prediction.estimated_date }}
                    </small>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-chart-line me-1"></i>Média: {{ "%.1f"|format(prediction.daily_average) }} petições/dia
                    </small>
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>{{ prediction.message }}</small>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Insights Card -->
            {% if insights %}
            <div class="dashboard-card">
                <h6 class="mb-3" style="font-weight: 600; color: var(--dark-color);">
                    <i class="fas fa-lightbulb me-2"></i>Insights de Uso
                </h6>
                
                {% if insights.trend %}
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="text-muted small">Tendência:</span>
                        <span class="badge {% if insights.trend == 'up' %}bg-danger{% elif insights.trend == 'down' %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if insights.trend == 'up' %}
                                <i class="fas fa-arrow-up"></i> Crescendo {{ "%.0f"|format(insights.growth_rate) }}%
                            {% elif insights.trend == 'down' %}
                                <i class="fas fa-arrow-down"></i> Reduzindo {{ "%.0f"|format(-insights.growth_rate) }}%
                            {% else %}
                                <i class="fas fa-minus"></i> Estável
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endif %}
                
                {% if insights.peak_day %}
                <div>
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="text-muted small">Dia com mais uso:</span>
                        <strong class="text-primary">{{ insights.peak_day }}</strong>
                    </div>
                    <small class="text-muted d-block mt-1">
                        {{ insights.peak_count }} petições neste dia
                    </small>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Activity Timeline (Optional) -->
    <div class="row g-4 mt-1">
        <div class="col-12">
            <div class="dashboard-card">
                <h5 class="mb-4" style="font-weight: 600; color: var(--dark-color);">
                    <i class="fas fa-history me-2"></i>Atividade Recente
                </h5>
                <div class="text-center py-4">
                    <i class="fas fa-clock fa-2x text-muted mb-3"></i>
                    <p class="text-muted mb-0">Nenhuma atividade recente</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{% if usage_history and not petition_usage.is_unlimited %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dados do histórico de uso
    var usageData = {{ usage_history|tojson }};
    
    // Preparar dados para o gráfico
    var categories = usageData.map(function(item) { return item.cycle; });
    var billableData = usageData.map(function(item) { return item.billable; });
    var freeData = usageData.map(function(item) { return item.free; });
    var totalData = usageData.map(function(item) { return item.total; });
    
    // Configuração do gráfico ApexCharts
    var options = {
        series: [{
            name: 'Petições Pagas',
            data: billableData,
            color: '#0d6efd'
        }, {
            name: 'Petições Gratuitas',
            data: freeData,
            color: '#198754'
        }],
        chart: {
            type: 'area',
            height: 350,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.3,
                stops: [0, 90, 100]
            }
        },
        xaxis: {
            categories: categories,
            title: {
                text: 'Mês',
                style: {
                    fontSize: '14px',
                    fontWeight: 600
                }
            }
        },
        yaxis: {
            title: {
                text: 'Número de Petições',
                style: {
                    fontSize: '14px',
                    fontWeight: 600
                }
            },
            labels: {
                formatter: function(val) {
                    return Math.floor(val);
                }
            }
        },
        tooltip: {
            shared: true,
            intersect: false,
            y: {
                formatter: function(val) {
                    return val + ' petições';
                }
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'left',
            fontSize: '14px',
            markers: {
                width: 12,
                height: 12,
                radius: 2
            }
        },
        grid: {
            borderColor: '#e7e7e7',
            strokeDashArray: 3
        }
    };
    
    var chart = new ApexCharts(document.querySelector("#usageHistoryChart"), options);
    chart.render();
});
</script>
{% endif %}

<script>
// Notification Toast Management
document.addEventListener('DOMContentLoaded', function() {
    const notificationToasts = document.querySelectorAll('.notification-toast');
    
    // Reproduzir som de notificação (opcional - apenas se houver notificações)
    if (notificationToasts.length > 0) {
        playNotificationSound();
    }
    
    notificationToasts.forEach(function(toastElement) {
        const notificationId = toastElement.dataset.notificationId;
        
        // Auto-hide notification after 15 seconds
        setTimeout(function() {
            const bsToast = bootstrap.Toast.getOrCreateInstance(toastElement);
            bsToast.hide();
        }, 15000);
        
        // Mark as read when closed
        toastElement.addEventListener('hidden.bs.toast', function() {
            // Mark notification as read via AJAX
            fetch(`/notifications/mark-read/${notificationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            }).then(response => {
                if (response.ok) {
                    console.log('Notificação marcada como lida');
                    // Remove element from DOM
                    toastElement.remove();
                }
            }).catch(error => {
                console.error('Erro ao marcar notificação:', error);
            });
        });
    });
    
    // Initialize Bootstrap toasts
    notificationToasts.forEach(function(toastElement) {
        new bootstrap.Toast(toastElement, {
            autohide: false  // Controlamos manualmente
        });
    });
    
    // Função para tocar som de notificação (Web Audio API)
    function playNotificationSound() {
        try {
            // Criar contexto de áudio
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Criar oscilador (gerador de tom)
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Configurar tom suave (750Hz)
            oscillator.frequency.value = 750;
            oscillator.type = 'sine';
            
            // Controlar volume (fade in/out)
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
            
            // Tocar por 0.3 segundos
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (error) {
            // Silenciosamente falhar se áudio não for suportado
            console.log('Som de notificação não disponível');
        }
    }
});
</script>
{% endblock %}
