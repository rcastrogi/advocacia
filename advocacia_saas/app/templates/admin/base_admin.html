{% extends "base.html" %}

{% block styles %}
    <!-- DataTables CSS (admin only) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.6.2/css/colReorder.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar de navegação admin -->
        <div class="col-lg-2 mb-4 admin-sidebar-col">
            <div class="card shadow-sm admin-sidebar">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i><span class="menu-title">Administração</span>
                    </h6>
                    <button id="sidebar-toggle" class="btn btn-sm btn-outline-light" title="Minimizar menu">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('admin.dashboard') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if request.endpoint == 'admin.dashboard' else '' }}"
                       title="Dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i><span>Dashboard</span>
                    </a>
                    <a href="{{ url_for('admin.users_list') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'users' in request.endpoint else '' }}"
                       title="Gerenciar Usuários">
                        <i class="fas fa-users me-2"></i><span>Usuários</span>
                    </a>
                    <a href="{{ url_for('main.admin_testimonials') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'testimonials' in request.endpoint else '' }}"
                       title="Gerenciar Depoimentos">
                        <i class="fas fa-comments me-2"></i><span>Depoimentos</span>
                    </a>
                    <a href="{{ url_for('billing.plans') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'billing' in request.endpoint else '' }}"
                       title="Gerenciar Planos">
                        <i class="fas fa-tags me-2"></i><span>Planos</span>
                    </a>
                    <a href="{{ url_for('admin.petition_types_list') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'petition_types' in request.endpoint else '' }}"
                       title="Tipos de Petição">
                        <i class="fas fa-file-alt me-2"></i><span>Tipos de Petição</span>
                    </a>
                    <a href="{{ url_for('admin.petition_models_list') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'petition_models' in request.endpoint else '' }}"
                       title="Modelos de Petição">
                        <i class="fas fa-cogs me-2"></i><span>Modelos de Petição</span>
                    </a>
                    <a href="{{ url_for('admin.petition_sections_list') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'petition_sections' in request.endpoint else '' }}"
                       title="Seções de Petição">
                        <i class="fas fa-puzzle-piece me-2"></i><span>Seções de Petição</span>
                    </a>
                    <a href="{{ url_for('admin.roadmap') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'roadmap' in request.endpoint and 'feedback' not in request.endpoint else '' }}"
                       title="Roadmap">
                        <i class="fas fa-road me-2"></i><span>Roadmap</span>
                    </a>
                    <a href="{{ url_for('admin.roadmap_feedback') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'roadmap_feedback' in request.endpoint else '' }}"
                       title="Feedback Roadmap">
                        <i class="fas fa-people-arrows me-2"></i><span>Feedback Roadmap</span>
                    </a>
                    <a href="{{ url_for('admin.audit_logs') }}" 
                       class="list-group-item list-group-item-action {{ 'active' if 'audit_logs' in request.endpoint else '' }}"
                       title="Logs de Auditoria">
                        <i class="fas fa-history me-2"></i><span>Logs de Auditoria</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Conteúdo principal -->
        <div class="col-lg-10 admin-content">
            {% block admin_content %}{% endblock %}
        </div>
    </div>
</div>

<style>
/* Menu Admin Minimizable */
.admin-sidebar {
    transition: width 0.3s ease;
}

.admin-sidebar.minimized {
    width: 70px;
}

.admin-sidebar.minimized .menu-title {
    display: none;
}

.admin-sidebar.minimized .list-group-item {
    text-align: center;
    padding: 12px 8px;
}

.admin-sidebar.minimized .list-group-item i {
    margin: 0;
    font-size: 1.2em;
}

.admin-sidebar.minimized .list-group-item span {
    display: none;
}

.admin-sidebar.minimized .card-header {
    justify-content: center !important;
}

.admin-sidebar.minimized .card-header .menu-title {
    display: none;
}

.admin-sidebar.minimized .card-header h6 .fa-cog {
    display: none;
}

/* Responsividade */
@media (max-width: 991.98px) {
    .admin-sidebar.minimized {
        width: 50px;
    }
}

/* Reduce gap when menu is minimized for better space efficiency */
body.admin-sidebar-min .admin-sidebar-col {
    padding-right: 2px !important;
}
body.admin-sidebar-min .admin-content {
    padding-left: 4px !important;
}
.admin-sidebar.minimized {
    width: 58px !important; /* increased by 10px when minimized */
}
/* Force smaller gutters and tighter spacing when minimized */
@media (min-width: 992px) {
    body.admin-sidebar-min .row {
        --bs-gutter-x: 0.25rem !important;
    }
    body.admin-sidebar-min .admin-sidebar-col {
        max-width: 68px !important; /* increased to match sidebar */
        width: 68px !important;
    }
    body.admin-sidebar-min .admin-content {
        margin-left: 0 !important;
    }
}
/* Small tweak for header alignment */
.admin-sidebar.minimized .card-header {
    padding-left: 8px !important;
}

/* Keep the toggle button compact and fully inside the minimized header */
.admin-sidebar.minimized #sidebar-toggle {
    width: 32px !important;
    height: 32px !important;
    padding: 4px !important;
    line-height: 1 !important;
    font-size: 12px !important;
    box-sizing: border-box !important;
    border-radius: 4px !important;
}

.admin-sidebar.minimized #sidebar-toggle i {
    font-size: 12px !important;
}

/* Ensure header doesn't overflow when minimized */
.admin-sidebar.minimized .card-header {
    overflow: hidden;
    padding-right: 4px !important;
}
</style>

<script>
// Controle do menu admin minimizável
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.querySelector('.admin-sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const toggleIcon = toggleBtn.querySelector('i');

    // Carregar estado salvo
    const isMinimized = localStorage.getItem('adminSidebarMinimized') === 'true';
    const contentDiv = document.querySelector('.admin-content');
    const sidebarCol = document.querySelector('.admin-sidebar-col');
    
    if (isMinimized) {
        sidebar.classList.add('minimized');
        document.body.classList.add('admin-sidebar-min');
        toggleIcon.className = 'fas fa-angle-right';
        toggleBtn.title = 'Expandir menu';
        // Ajustar largura das colunas
        if (sidebarCol && contentDiv) {
            sidebarCol.classList.remove('col-lg-2');
            sidebarCol.classList.add('col-lg-1');
            contentDiv.classList.remove('col-lg-10');
            contentDiv.classList.add('col-lg-11');
        }
    }

    // Toggle do menu
    toggleBtn.addEventListener('click', function() {
        const isMinimized = sidebar.classList.toggle('minimized');
        const contentDiv = document.querySelector('.admin-content');
        const sidebarCol = document.querySelector('.admin-sidebar-col');

        if (isMinimized) {
            toggleIcon.className = 'fas fa-angle-right';
            toggleBtn.title = 'Expandir menu';
            localStorage.setItem('adminSidebarMinimized', 'true');
            document.body.classList.add('admin-sidebar-min');
            // Ajustar largura das colunas
            if (sidebarCol && contentDiv) {
                sidebarCol.classList.remove('col-lg-2');
                sidebarCol.classList.add('col-lg-1');
                contentDiv.classList.remove('col-lg-10');
                contentDiv.classList.add('col-lg-11');
            }
        } else {
            toggleIcon.className = 'fas fa-bars';
            toggleBtn.title = 'Minimizar menu';
            localStorage.setItem('adminSidebarMinimized', 'false');
            document.body.classList.remove('admin-sidebar-min');
            // Restaurar largura das colunas
            if (sidebarCol && contentDiv) {
                sidebarCol.classList.remove('col-lg-1');
                sidebarCol.classList.add('col-lg-2');
                contentDiv.classList.remove('col-lg-11');
                contentDiv.classList.add('col-lg-10');
            }
        }
    });

    // Adicionar tooltips aos itens do menu quando minimizado
    const menuItems = document.querySelectorAll('.list-group-item');
    menuItems.forEach(item => {
        const text = item.textContent.trim();
        if (text && !item.hasAttribute('title')) {
            item.setAttribute('title', text);
        }
    });
});
</script>

{% block scripts %}
    <!-- Load jQuery first (blocking) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Load DataTables and extensions (blocking, sequentially) -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
    
    <!-- Load our table prefs component -->
    <script src="{{ url_for('static', filename='js/table_prefs.js') }}?v={{ range(1,10000) | random }}"></script>
    
    <!-- Initialize tables after all libraries loaded -->
    <script>
    (function(){
        // Simple check - wait for $ to be defined
        var maxRetries = 50;
        var retries = 0;
        
        function init(){
            retries++;
            
            // Check if jQuery and DataTable are available
            if(typeof jQuery === 'undefined' || typeof jQuery.fn.DataTable === 'undefined'){
                console.log('[admin-init] jQuery or DataTable not ready, retry', retries);
                if(retries < maxRetries){
                    setTimeout(init, 100);
                }
                return;
            }
            
            console.log('[admin-init] jQuery and DataTable ready, initializing tables');
            
            // Call the table prefs component
            if(typeof window.initAdminTables === 'function'){
                console.log('[admin-init] Calling initAdminTables');
                window.initAdminTables();
            } else {
                console.warn('[admin-init] initAdminTables not found');
            }
        }
        
        // Start initialization after DOM is ready
        if(document.readyState === 'loading'){
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
{% endblock %}

{% endblock %}
