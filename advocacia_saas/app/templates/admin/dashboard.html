{% extends "admin/base_admin.html" %}

{% block admin_content %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Cabe√ßalho -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard Administrativo
        </h2>
        <p class="text-muted mb-0">Vis√£o geral da plataforma - {{ current_month }}</p>
    </div>
    <div>
        <a href="{{ url_for('admin.users_list') }}" class="btn btn-outline-primary">
            <i class="fas fa-users me-2"></i>Ver Todos os Usu√°rios
        </a>
    </div>
</div>

<!-- Cards de M√©tricas Principais -->
<div class="row g-4 mb-4">
    <!-- Usu√°rios -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                            <i class="fas fa-users fa-2x text-primary"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0">{{ total_users }}</h3>
                        <small class="text-muted">Usu√°rios Total</small>
                    </div>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-between small">
                    <span class="text-success">
                        <i class="fas fa-user-plus me-1"></i>+{{ new_users_month }} este m√™s
                    </span>
                    <span class="text-muted">{{ active_users }} ativos</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Usu√°rios Pagantes -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="fas fa-dollar-sign fa-2x text-success"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0">{{ paying_users }}</h3>
                        <small class="text-muted">Usu√°rios Pagantes</small>
                    </div>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-between small">
                    <span class="text-primary">
                        {% if total_users > 0 %}
                        {{ "%.1f"|format(paying_users / total_users * 100) }}% convers√£o
                        {% else %}
                        0% convers√£o
                        {% endif %}
                    </span>
                    <span class="text-success">
                        R$ {{ "%.2f"|format(payments_month) }} m√™s
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Peti√ß√µes -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3">
                            <i class="fas fa-file-signature fa-2x text-info"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0">{{ petitions_month }}</h3>
                        <small class="text-muted">Peti√ß√µes no M√™s</small>
                    </div>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-between small">
                    <span class="text-muted">{{ total_petitions }} total</span>
                    <span class="text-success">
                        R$ {{ "%.2f"|format(petitions_value_month) }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clientes -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                            <i class="fas fa-address-book fa-2x text-warning"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0">{{ total_clients }}</h3>
                        <small class="text-muted">Clientes Cadastrados</small>
                    </div>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-between small">
                    <span class="text-success">
                        <i class="fas fa-plus me-1"></i>+{{ new_clients_month }} este m√™s
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cards de IA -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <h5 class="text-muted mb-3">
            <i class="fas fa-robot me-2"></i>M√©tricas de Intelig√™ncia Artificial
        </h5>
    </div>
    
    <!-- Gera√ß√µes de IA -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100 border-start border-4 border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1">Gera√ß√µes IA (M√™s)</p>
                        <h4 class="mb-0">{{ ai_generations_month }}</h4>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-magic fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tokens Usados -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100 border-start border-4 border-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1">Tokens Usados (M√™s)</p>
                        <h4 class="mb-0">{{ "{:,}".format(tokens_month) }}</h4>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-microchip fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custo IA -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100 border-start border-4 border-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1">Custo IA (M√™s)</p>
                        <h4 class="mb-0">$ {{ "%.4f"|format(ai_cost_month) }}</h4>
                    </div>
                    <div class="text-danger">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cr√©ditos Vendidos -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100 border-start border-4 border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1">Cr√©ditos Vendidos (M√™s)</p>
                        <h4 class="mb-0">{{ credits_sold_month }}</h4>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-coins fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SE√á√ÉO DE GR√ÅFICOS -->
<div class="row g-4 mb-4 mt-2">
    <div class="col-12">
        <h5 class="text-muted mb-3">
            <i class="fas fa-chart-line me-2"></i>Evolu√ß√£o nos √öltimos 12 Meses
        </h5>
    </div>
    
    <!-- Gr√°fico de Faturamento Geral -->
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="fas fa-dollar-sign text-success me-2"></i>Faturamento Mensal (R$)
                </h6>
            </div>
            <div class="card-body">
                <canvas id="chartRevenue" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gr√°fico de Faturamento por Plano -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="fas fa-tags text-primary me-2"></i>Faturamento por Plano (R$)
                </h6>
            </div>
            <div class="card-body">
                <canvas id="chartRevenueByPlan" height="150"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gr√°fico de IA - Uso e Custo -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="fas fa-robot text-info me-2"></i>Uso de IA (Gera√ß√µes)
                </h6>
            </div>
            <div class="card-body">
                <canvas id="chartAIUsage" height="150"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gr√°fico de IA - Custo vs Cr√©ditos -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="fas fa-coins text-warning me-2"></i>Cr√©ditos IA Vendidos
                </h6>
            </div>
            <div class="card-body">
                <canvas id="chartAICredits" height="150"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gr√°fico de Custo IA -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-area text-danger me-2"></i>Custo de IA (USD)
                </h6>
            </div>
            <div class="card-body">
                <canvas id="chartAICost" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabelas de Rankings -->
<div class="row g-4">
    <!-- Top Usu√°rios - Peti√ß√µes -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="fas fa-trophy text-warning me-2"></i>Top Usu√°rios - Peti√ß√µes (M√™s)
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Usu√°rio</th>
                                <th class="text-center">Peti√ß√µes</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in top_users_petitions %}
                            <tr>
                                <td>
                                    {% if loop.index == 1 %}
                                    <span class="badge bg-warning text-dark">ü•á</span>
                                    {% elif loop.index == 2 %}
                                    <span class="badge bg-secondary">ü•à</span>
                                    {% elif loop.index == 3 %}
                                    <span class="badge bg-warning-subtle text-warning">ü•â</span>
                                    {% else %}
                                    {{ loop.index }}
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="text-decoration-none">
                                        {{ user.full_name or user.username }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ user.email }}</small>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ user.petition_count }}</span>
                                </td>
                                <td class="text-end">R$ {{ "%.2f"|format(user.total_value) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    Nenhuma peti√ß√£o gerada este m√™s
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Usu√°rios - IA -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="fas fa-robot text-primary me-2"></i>Top Usu√°rios - Uso de IA (M√™s)
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Usu√°rio</th>
                                <th class="text-center">Gera√ß√µes</th>
                                <th class="text-end">Tokens</th>
                                <th class="text-end">Custo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in top_users_ai %}
                            <tr>
                                <td>
                                    {% if loop.index == 1 %}
                                    <span class="badge bg-warning text-dark">ü•á</span>
                                    {% elif loop.index == 2 %}
                                    <span class="badge bg-secondary">ü•à</span>
                                    {% elif loop.index == 3 %}
                                    <span class="badge bg-warning-subtle text-warning">ü•â</span>
                                    {% else %}
                                    {{ loop.index }}
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="text-decoration-none">
                                        {{ user.full_name or user.username }}
                                    </a>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ user.generation_count }}</span>
                                </td>
                                <td class="text-end">{{ "{:,}".format(user.total_tokens) }}</td>
                                <td class="text-end">$ {{ "%.4f"|format(user.total_cost) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    Nenhum uso de IA este m√™s
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Usu√°rios Recentes -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-user-plus text-success me-2"></i>Usu√°rios Recentes
                </h6>
                <a href="{{ url_for('admin.users_list') }}" class="btn btn-sm btn-outline-primary">
                    Ver Todos
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Usu√°rio</th>
                                <th>Email</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Cadastro</th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in recent_users %}
                            <tr>
                                <td>
                                    <strong>{{ user.full_name or user.username }}</strong>
                                    {% if user.oab_number %}
                                    <br><small class="text-muted">OAB: {{ user.oab_number }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.user_type == 'advogado' %}
                                    <span class="badge bg-primary">Advogado</span>
                                    {% elif user.user_type == 'escritorio' %}
                                    <span class="badge bg-info">Escrit√≥rio</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ user.user_type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                    <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inativo</span>
                                    {% endif %}
                                    {% if user.billing_status == 'delinquent' %}
                                    <span class="badge bg-warning text-dark">Inadimplente</span>
                                    {% elif user.billing_status == 'trial' %}
                                    <span class="badge bg-info">Trial</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ user.created_at.strftime('%d/%m/%Y') if user.created_at else '-' }}
                                    <br>
                                    <small class="text-muted">
                                        {{ user.created_at.strftime('%H:%M') if user.created_at else '' }}
                                    </small>
                                </td>
                                <td class="text-end">
                                    <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts dos Gr√°ficos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dados dos gr√°ficos (passados do backend)
    const labels = {{ chart_labels | tojson }};
    const revenueData = {{ chart_revenue | tojson }};
    const revenueByPlan = {{ chart_revenue_by_plan | tojson }};
    const aiUsageData = {{ chart_ai_usage | tojson }};
    const aiCostData = {{ chart_ai_cost | tojson }};
    const aiCreditsData = {{ chart_ai_credits_sold | tojson }};
    
    // Cores para os planos
    const planColors = [
        'rgba(54, 162, 235, 0.8)',   // Azul
        'rgba(255, 99, 132, 0.8)',   // Rosa
        'rgba(75, 192, 192, 0.8)',   // Verde √°gua
        'rgba(255, 206, 86, 0.8)',   // Amarelo
        'rgba(153, 102, 255, 0.8)',  // Roxo
        'rgba(255, 159, 64, 0.8)',   // Laranja
        'rgba(199, 199, 199, 0.8)',  // Cinza
    ];
    
    // 1. Gr√°fico de Faturamento Geral
    new Chart(document.getElementById('chartRevenue'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Faturamento (R$)',
                data: revenueData,
                backgroundColor: 'rgba(40, 167, 69, 0.6)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'R$ ' + context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            }
        }
    });
    
    // 2. Gr√°fico de Faturamento por Plano (Stacked Bar)
    const planDatasets = [];
    let colorIndex = 0;
    for (const [planName, planData] of Object.entries(revenueByPlan)) {
        planDatasets.push({
            label: planName,
            data: planData,
            backgroundColor: planColors[colorIndex % planColors.length],
            borderColor: planColors[colorIndex % planColors.length].replace('0.8', '1'),
            borderWidth: 1,
            borderRadius: 3,
        });
        colorIndex++;
    }
    
    new Chart(document.getElementById('chartRevenueByPlan'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: planDatasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 10 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': R$ ' + context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            }
        }
    });
    
    // 3. Gr√°fico de Uso de IA (Line)
    new Chart(document.getElementById('chartAIUsage'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Gera√ß√µes de IA',
                data: aiUsageData,
                borderColor: 'rgba(23, 162, 184, 1)',
                backgroundColor: 'rgba(23, 162, 184, 0.2)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: 'rgba(23, 162, 184, 1)',
                pointRadius: 4,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
    
    // 4. Gr√°fico de Cr√©ditos Vendidos (Bar)
    new Chart(document.getElementById('chartAICredits'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cr√©ditos Vendidos',
                data: aiCreditsData,
                backgroundColor: 'rgba(255, 193, 7, 0.6)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 2,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 10 }
                }
            }
        }
    });
    
    // 5. Gr√°fico de Custo IA (Line + Area)
    new Chart(document.getElementById('chartAICost'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Custo IA (USD)',
                data: aiCostData,
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.2)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                pointRadius: 4,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$ ' + context.raw.toFixed(4);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$ ' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
