{% extends "base.html" %}

{% block title %}Privacidade e LGPD - Petitio{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-shield-alt"></i> Privacidade e LGPD</h2>
                    <p class="mb-0">Gerencie seus dados pessoais e direitos conforme a Lei Geral de Proteção de Dados (LGPD)</p>
                </div>
                <div class="card-body">
                    <!-- Consentimentos -->
                    <div class="mb-4">
                        <h4><i class="fas fa-check-circle"></i> Consentimentos de Dados</h4>
                        <p>Gerencie seus consentimentos para tratamento de dados pessoais.</p>
                        <button class="btn btn-primary" onclick="showConsentModal()">
                            <i class="fas fa-plus"></i> Gerenciar Consentimentos
                        </button>
                        <div id="consents-list" class="mt-3">
                            <!-- Lista de consentimentos será carregada aqui -->
                        </div>
                    </div>

                    <hr>

                    <!-- Solicitações -->
                    <div class="mb-4">
                        <h4><i class="fas fa-user-shield"></i> Seus Direitos</h4>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <h5 class="card-title">Direito ao Esquecimento</h5>
                                        <p class="card-text">Solicite a exclusão permanente dos seus dados.</p>
                                        <button class="btn btn-warning" onclick="showDeletionModal()">
                                            <i class="fas fa-trash-alt"></i> Solicitar Exclusão
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h5 class="card-title">Anonimização de Dados</h5>
                                        <p class="card-text">Solicite anonimização dos seus dados pessoais.</p>
                                        <button class="btn btn-info" onclick="showAnonymizationModal()">
                                            <i class="fas fa-mask"></i> Solicitar Anonimização
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Histórico -->
                    <div class="mb-4">
                        <h4><i class="fas fa-history"></i> Histórico de Processamento</h4>
                        <p>Veja como seus dados foram processados pela plataforma.</p>
                        <button class="btn btn-secondary" onclick="loadProcessingLog()">
                            <i class="fas fa-list"></i> Ver Histórico
                        </button>
                        <div id="processing-log" class="mt-3" style="display: none;">
                            <!-- Histórico será carregado aqui -->
                        </div>
                    </div>

                    <!-- Status das Solicitações -->
                    <div class="mb-4">
                        <h4><i class="fas fa-tasks"></i> Status das Solicitações</h4>
                        <div id="requests-status">
                            <!-- Status será carregado aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Consentimento -->
<div class="modal fade" id="consentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gerenciar Consentimentos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="consent-form">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Consentimento</label>
                        <select class="form-select" name="consent_type" required>
                            <option value="marketing">Marketing e Comunicação</option>
                            <option value="analytics">Análise de Uso</option>
                            <option value="processing">Processamento de Dados</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Finalidade</label>
                        <textarea class="form-control" name="consent_purpose" rows="3" required
                                  placeholder="Descreva para que seus dados serão utilizados"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Dar Consentimento</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Exclusão -->
<div class="modal fade" id="deletionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Solicitar Exclusão de Dados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Atenção:</strong> Esta ação é irreversível. Todos os seus dados serão permanentemente excluídos.
                </div>
                <form id="deletion-form">
                    <div class="mb-3">
                        <label class="form-label">Motivo da Solicitação</label>
                        <textarea class="form-control" name="reason" rows="3" required
                                  placeholder="Explique o motivo da solicitação de exclusão"></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger">Solicitar Exclusão</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Anonimização -->
<div class="modal fade" id="anonymizationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Solicitar Anonimização</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Anonimização:</strong> Seus dados pessoais serão substituídos por identificadores anônimos.
                </div>
                <form id="anonymization-form">
                    <div class="mb-3">
                        <label class="form-label">Motivo da Solicitação</label>
                        <textarea class="form-control" name="reason" rows="3" required
                                  placeholder="Explique o motivo da solicitação de anonimização"></textarea>
                    </div>
                    <button type="submit" class="btn btn-info">Solicitar Anonimização</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Carregar dados ao carregar página
document.addEventListener('DOMContentLoaded', function() {
    loadConsents();
    loadRequestsStatus();
});

// Funções para modais
function showConsentModal() {
    $('#consentModal').modal('show');
}

function showDeletionModal() {
    $('#deletionModal').modal('show');
}

function showAnonymizationModal() {
    $('#anonymizationModal').modal('show');
}

// Carregar consentimentos
function loadConsents() {
    fetch('/lgpd/consent')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('consents-list');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum consentimento registrado.</p>';
                return;
            }

            let html = '<div class="list-group">';
            data.forEach(consent => {
                const status = consent.consented ?
                    '<span class="badge bg-success">Ativo</span>' :
                    '<span class="badge bg-secondary">Retirado</span>';

                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${consent.consent_type}</h6>
                            ${status}
                        </div>
                        <p class="mb-1">${consent.consent_purpose}</p>
                        <small class="text-muted">
                            Concedido em: ${new Date(consent.consented_at).toLocaleDateString('pt-BR')}
                            ${consent.withdrawn_at ? '<br>Retirado em: ' + new Date(consent.withdrawn_at).toLocaleDateString('pt-BR') : ''}
                        </small>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        })
        .catch(error => console.error('Erro ao carregar consentimentos:', error));
}

// Carregar status das solicitações
function loadRequestsStatus() {
    Promise.all([
        fetch('/lgpd/deletion-request').then(r => r.json()),
        fetch('/lgpd/anonymization-request').then(r => r.json())
    ])
    .then(([deletions, anonymizations]) => {
        const container = document.getElementById('requests-status');

        if (deletions.length === 0 && anonymizations.length === 0) {
            container.innerHTML = '<p class="text-muted">Nenhuma solicitação registrada.</p>';
            return;
        }

        let html = '<div class="row">';

        // Solicitações de exclusão
        if (deletions.length > 0) {
            html += '<div class="col-md-6">';
            html += '<h6>Solicitações de Exclusão</h6>';
            html += '<ul class="list-group">';
            deletions.forEach(req => {
                const statusClass = req.status === 'completed' ? 'success' :
                                  req.status === 'rejected' ? 'danger' : 'warning';
                html += `<li class="list-group-item">
                    <span class="badge bg-${statusClass}">${req.status}</span>
                    <small class="text-muted d-block">${new Date(req.requested_at).toLocaleDateString('pt-BR')}</small>
                </li>`;
            });
            html += '</ul></div>';
        }

        // Solicitações de anonimização
        if (anonymizations.length > 0) {
            html += '<div class="col-md-6">';
            html += '<h6>Solicitações de Anonimização</h6>';
            html += '<ul class="list-group">';
            anonymizations.forEach(req => {
                const statusClass = req.status === 'completed' ? 'success' :
                                  req.status === 'failed' ? 'danger' : 'warning';
                html += `<li class="list-group-item">
                    <span class="badge bg-${statusClass}">${req.status}</span>
                    <small class="text-muted d-block">${new Date(req.requested_at).toLocaleDateString('pt-BR')}</small>
                </li>`;
            });
            html += '</ul></div>';
        }

        html += '</div>';
        container.innerHTML = html;
    })
    .catch(error => console.error('Erro ao carregar status:', error));
}

// Carregar log de processamento
function loadProcessingLog() {
    const container = document.getElementById('processing-log');

    if (container.style.display === 'none') {
        fetch('/lgpd/processing-log')
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    container.innerHTML = '<p class="text-muted">Nenhum processamento registrado.</p>';
                    return;
                }

                let html = '<div class="table-responsive"><table class="table table-sm">';
                html += '<thead><tr><th>Data</th><th>Ação</th><th>Categoria</th><th>Finalidade</th></tr></thead><tbody>';

                data.forEach(log => {
                    html += `<tr>
                        <td>${new Date(log.processed_at).toLocaleString('pt-BR')}</td>
                        <td>${log.action}</td>
                        <td>${log.data_category}</td>
                        <td>${log.purpose}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;
                container.style.display = 'block';
            })
            .catch(error => console.error('Erro ao carregar log:', error));
    } else {
        container.style.display = 'none';
    }
}

// Formulários
document.getElementById('consent-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/lgpd/consent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Erro: ' + result.error);
        } else {
            alert('Consentimento registrado com sucesso!');
            $('#consentModal').modal('hide');
            loadConsents();
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao registrar consentimento');
    });
});

document.getElementById('deletion-form').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!confirm('Tem certeza que deseja solicitar a exclusão permanente de todos os seus dados? Esta ação não pode ser desfeita.')) {
        return;
    }

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/lgpd/deletion-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Erro: ' + result.error);
        } else {
            alert('Solicitação de exclusão registrada! Você será notificado sobre o andamento.');
            $('#deletionModal').modal('hide');
            loadRequestsStatus();
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao registrar solicitação');
    });
});

document.getElementById('anonymization-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/lgpd/anonymization-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Erro: ' + result.error);
        } else {
            alert('Solicitação de anonimização registrada! Você será notificado sobre o andamento.');
            $('#anonymizationModal').modal('hide');
            loadRequestsStatus();
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao registrar solicitação');
    });
});
</script>
{% endblock %}