services:
  - type: web
    name: petitio
    env: python
    plan: free
    buildCommand: |
      cd advocacia_saas
      pip install -r requirements.txt
      python << 'EOPYTHON'
      from app import create_app, db
      from app.models import User, Estado, Cidade

      app = create_app()
      with app.app_context():
          db.create_all()
          print("âœ… Tabelas criadas")
          
          # Criar admin se nÃ£o existir
          if User.query.count() == 0:
              admin = User(username='admin', email='admin@petitio.com', user_type='master')
              admin.set_password('admin123')
              db.session.add(admin)
              db.session.commit()
              print("âœ… Admin criado")
          
          # Popular estados se nÃ£o existirem
          if Estado.query.count() == 0:
              estados = [
                  {'sigla': 'AC', 'nome': 'Acre'},
                  {'sigla': 'AL', 'nome': 'Alagoas'},
                  {'sigla': 'AP', 'nome': 'AmapÃ¡'},
                  {'sigla': 'AM', 'nome': 'Amazonas'},
                  {'sigla': 'BA', 'nome': 'Bahia'},
                  {'sigla': 'CE', 'nome': 'CearÃ¡'},
                  {'sigla': 'DF', 'nome': 'Distrito Federal'},
                  {'sigla': 'ES', 'nome': 'EspÃ­rito Santo'},
                  {'sigla': 'GO', 'nome': 'GoiÃ¡s'},
                  {'sigla': 'MA', 'nome': 'MaranhÃ£o'},
                  {'sigla': 'MT', 'nome': 'Mato Grosso'},
                  {'sigla': 'MS', 'nome': 'Mato Grosso do Sul'},
                  {'sigla': 'MG', 'nome': 'Minas Gerais'},
                  {'sigla': 'PA', 'nome': 'ParÃ¡'},
                  {'sigla': 'PB', 'nome': 'ParaÃ­ba'},
                  {'sigla': 'PR', 'nome': 'ParanÃ¡'},
                  {'sigla': 'PE', 'nome': 'Pernambuco'},
                  {'sigla': 'PI', 'nome': 'PiauÃ­'},
                  {'sigla': 'RJ', 'nome': 'Rio de Janeiro'},
                  {'sigla': 'RN', 'nome': 'Rio Grande do Norte'},
                  {'sigla': 'RS', 'nome': 'Rio Grande do Sul'},
                  {'sigla': 'RO', 'nome': 'RondÃ´nia'},
                  {'sigla': 'RR', 'nome': 'Roraima'},
                  {'sigla': 'SC', 'nome': 'Santa Catarina'},
                  {'sigla': 'SP', 'nome': 'SÃ£o Paulo'},
                  {'sigla': 'SE', 'nome': 'Sergipe'},
                  {'sigla': 'TO', 'nome': 'Tocantins'}
              ]
              
              cidades = {
                  'SP': ['SÃ£o Paulo', 'Campinas', 'Santos'],
                  'RJ': ['Rio de Janeiro', 'NiterÃ³i', 'PetrÃ³polis'],
                  'MG': ['Belo Horizonte', 'UberlÃ¢ndia', 'Contagem'],
                  'BA': ['Salvador', 'Feira de Santana', 'VitÃ³ria da Conquista'],
                  'PR': ['Curitiba', 'Londrina', 'MaringÃ¡'],
                  'RS': ['Porto Alegre', 'Caxias do Sul', 'Pelotas'],
                  'PE': ['Recife', 'JaboatÃ£o dos Guararapes', 'Olinda'],
                  'CE': ['Fortaleza', 'Caucaia', 'Juazeiro do Norte'],
                  'SC': ['FlorianÃ³polis', 'Joinville', 'Blumenau'],
                  'GO': ['GoiÃ¢nia', 'Aparecida de GoiÃ¢nia', 'AnÃ¡polis'],
                  'DF': ['BrasÃ­lia']
              }
              
              for est in estados:
                  e = Estado(sigla=est['sigla'], nome=est['nome'])
                  db.session.add(e)
                  db.session.flush()
                  
                  if est['sigla'] in cidades:
                      for c in cidades[est['sigla']]:
                          cidade = Cidade(nome=c, estado_id=e.id)
                          db.session.add(cidade)
              
              db.session.commit()
              print(f"âœ… {Estado.query.count()} estados e {Cidade.query.count()} cidades criados")
          
          print("ðŸŽ‰ Setup completo!")
      EOPYTHON
    startCommand: "cd advocacia_saas && gunicorn run:app --bind 0.0.0.0:$PORT"
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SECRET_KEY
        generateValue: true
      - key: FLASK_ENV
        value: production
      - key: DATABASE_URL
        value: sqlite:///app.db
